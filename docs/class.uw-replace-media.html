<!DOCTYPE html>

<html>
<head>
  <title>class.uw-replace-media.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="404.html">
                404.php
              </a>
            
              
              <a class="source" href="application.html">
                application.php
              </a>
            
              
              <a class="source" href="archive.html">
                archive.php
              </a>
            
              
              <a class="source" href="breadcrumbs.html">
                breadcrumbs.php
              </a>
            
              
              <a class="source" href="comments.html">
                comments.php
              </a>
            
              
              <a class="source" href="content-archive.html">
                content-archive.php
              </a>
            
              
              <a class="source" href="content-image.html">
                content-image.php
              </a>
            
              
              <a class="source" href="content-page.html">
                content-page.php
              </a>
            
              
              <a class="source" href="content-pdf.html">
                content-pdf.php
              </a>
            
              
              <a class="source" href="content.html">
                content.php
              </a>
            
              
              <a class="source" href="footer.html">
                footer.php
              </a>
            
              
              <a class="source" href="functions.html">
                functions.php
              </a>
            
              
              <a class="source" href="header-image.html">
                header-image.php
              </a>
            
              
              <a class="source" href="header.html">
                header.php
              </a>
            
              
              <a class="source" href="image.html">
                image.php
              </a>
            
              
              <a class="source" href="template-functions.html">
                template-functions.php
              </a>
            
              
              <a class="source" href="index.html">
                index.php
              </a>
            
              
              <a class="source" href="uw.html">
                uw.js
              </a>
            
              
              <a class="source" href="menu-mobile.html">
                menu-mobile.php
              </a>
            
              
              <a class="source" href="page.html">
                page.php
              </a>
            
              
              <a class="source" href="search.html">
                search.php
              </a>
            
              
              <a class="source" href="searchform.html">
                searchform.php
              </a>
            
              
              <a class="source" href="class.button-shortcode.html">
                class.button-shortcode.php
              </a>
            
              
              <a class="source" href="class.dropdowns_walker.html">
                class.dropdowns_walker.php
              </a>
            
              
              <a class="source" href="class.filters.html">
                class.filters.php
              </a>
            
              
              <a class="source" href="class.googleapps.html">
                class.googleapps.php
              </a>
            
              
              <a class="source" href="class.images.html">
                class.images.php
              </a>
            
              
              <a class="source" href="class.install.html">
                class.install.php
              </a>
            
              
              <a class="source" href="class.mimes.html">
                class.mimes.php
              </a>
            
              
              <a class="source" href="class.squish_bugs.html">
                class.squish_bugs.php
              </a>
            
              
              <a class="source" href="class.tile-box-shortcode.html">
                class.tile-box-shortcode.php
              </a>
            
              
              <a class="source" href="class.trumba-shortcode.html">
                class.trumba-shortcode.php
              </a>
            
              
              <a class="source" href="class.users.html">
                class.users.php
              </a>
            
              
              <a class="source" href="class.uw-carousel.html">
                class.uw-carousel.php
              </a>
            
              
              <a class="source" href="class.uw-directory.html">
                class.uw-directory.php
              </a>
            
              
              <a class="source" href="class.uw-documentation.html">
                class.uw-documentation.php
              </a>
            
              
              <a class="source" href="class.uw-dropdowns.html">
                class.uw-dropdowns.php
              </a>
            
              
              <a class="source" href="class.uw-enclosure.html">
                class.uw-enclosure.php
              </a>
            
              
              <a class="source" href="class.uw-iframes.html">
                class.uw-iframes.php
              </a>
            
              
              <a class="source" href="class.uw-media-caption.html">
                class.uw-media-caption.php
              </a>
            
              
              <a class="source" href="class.uw-media-credit.html">
                class.uw-media-credit.php
              </a>
            
              
              <a class="source" href="class.uw-oembeds.html">
                class.uw-oembeds.php
              </a>
            
              
              <a class="source" href="class.uw-page-attributes-meta-box.html">
                class.uw-page-attributes-meta-box.php
              </a>
            
              
              <a class="source" href="class.uw-quicklinks.html">
                class.uw-quicklinks.php
              </a>
            
              
              <a class="source" href="class.uw-replace-media.html">
                class.uw-replace-media.php
              </a>
            
              
              <a class="source" href="class.uw-scripts.html">
                class.uw-scripts.php
              </a>
            
              
              <a class="source" href="class.uw-shortcodes.html">
                class.uw-shortcodes.php
              </a>
            
              
              <a class="source" href="class.uw-styles.html">
                class.uw-styles.php
              </a>
            
              
              <a class="source" href="class.uw-tinymce.html">
                class.uw-tinymce.php
              </a>
            
              
              <a class="source" href="class.uw.html">
                class.uw.php
              </a>
            
              
              <a class="source" href="class.youtube-shortcode.html">
                class.youtube-shortcode.php
              </a>
            
              
              <a class="source" href="sidebar.html">
                sidebar.php
              </a>
            
              
              <a class="source" href="template-big-hero.html">
                template-big-hero.php
              </a>
            
              
              <a class="source" href="template-no-hero.html">
                template-no-hero.php
              </a>
            
              
              <a class="source" href="template-no-sidebar.html">
                template-no-sidebar.php
              </a>
            
              
              <a class="source" href="template-no-title.html">
                template-no-title.php
              </a>
            
              
              <a class="source" href="template-small-hero.html">
                template-small-hero.php
              </a>
            
              
              <a class="source" href="thinstrip.html">
                thinstrip.php
              </a>
            
              
              <a class="source" href="class.uw-blogroll.html">
                class.uw-blogroll.php
              </a>
            
              
              <a class="source" href="class.uw-campus-map.html">
                class.uw-campus-map.php
              </a>
            
              
              <a class="source" href="class.uw-intro.html">
                class.uw-intro.php
              </a>
            
              
              <a class="source" href="class.uw-recent-posts.html">
                class.uw-recent-posts.php
              </a>
            
              
              <a class="source" href="class.uw-related-posts.html">
                class.uw-related-posts.php
              </a>
            
              
              <a class="source" href="class.uw-rss.html">
                class.uw-rss.php
              </a>
            
              
              <a class="source" href="class.uw-sidebar.html">
                class.uw-sidebar.php
              </a>
            
              
              <a class="source" href="class.uw-single-image.html">
                class.uw-single-image.php
              </a>
            
              
              <a class="source" href="class.uw-top-posts.html">
                class.uw-top-posts.php
              </a>
            
              
              <a class="source" href="class.uw-twitter.html">
                class.uw-twitter.php
              </a>
            
              
              <a class="source" href="class.uw-widget-visibility.html">
                class.uw-widget-visibility.php
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>class.uw-replace-media.php</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-preprocessor">&lt;?php</span>

<span class="hljs-comment">/**
 * UW Replace Media adds a 'Replace media' button on PDF files.
 *
 * This removes the old pdf and upload the new one
 *  while maintaining the old url.
 *
 * WP by default changes the url for newly uploaded PDF files.
 */</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UW_Replace_Media</span>
</span>{

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">UW_Replace_Media</span><span class="hljs-params">()</span>
  </span>{
    add_filter( <span class="hljs-string">'attachment_fields_to_edit'</span>, <span class="hljs-keyword">array</span>( <span class="hljs-variable">$this</span>, <span class="hljs-string">'uw_edit_attachment_slug'</span>), <span class="hljs-number">10</span>, <span class="hljs-number">2</span> );
    add_filter( <span class="hljs-string">'attachment_fields_to_save'</span>, <span class="hljs-keyword">array</span>( <span class="hljs-variable">$this</span>, <span class="hljs-string">'uw_save_attachment_slug'</span>), <span class="hljs-number">10</span>, <span class="hljs-number">2</span> );
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uw_edit_attachment_slug</span><span class="hljs-params">( <span class="hljs-variable">$fields</span>, <span class="hljs-variable">$post</span> )</span>
  </span>{
    wp_enqueue_media();

    <span class="hljs-keyword">if</span> ( strpos( get_post_mime_type(<span class="hljs-variable">$post</span><span class="hljs-variable">-&gt;ID</span>), <span class="hljs-string">'application/'</span>) !== <span class="hljs-keyword">false</span> )
    {

      <span class="hljs-variable">$fields</span>[<span class="hljs-string">'replace_media'</span>] = <span class="hljs-keyword">array</span>(
          <span class="hljs-string">'label'</span> =&gt; __(<span class="hljs-string">'Replace Media'</span>),
          <span class="hljs-string">'input'</span> =&gt; <span class="hljs-string">'html'</span>,
          <span class="hljs-string">'html'</span> =&gt; <span class="hljs-string">'

          &lt;style type="text/css"&gt;
          div.media-sidebar tr.compat-field-replace_media {
            display:none;
          }
          &lt;/style&gt;

            &lt;div class="wp-media-buttons uw-replace-media"&gt;
              &lt;a href="#" class="button replace_media add_media" title="Replace Media"&gt;
                &lt;span class="wp-media-buttons-icon"&gt;&lt;/span&gt;
                Replace
              &lt;/a&gt;
              &lt;em class="help"&gt;&lt;/em&gt;
              '</span>.wp_nonce_field(<span class="hljs-string">'replace-media-'</span> . <span class="hljs-variable">$post</span><span class="hljs-variable">-&gt;ID</span>, <span class="hljs-string">'replace-media-nonce'</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>) .<span class="hljs-string">'
              &lt;input id="replace-media-input-'</span>. <span class="hljs-variable">$post</span><span class="hljs-variable">-&gt;ID</span> .<span class="hljs-string">'" type="hidden" name="replace_media_for_'</span>.<span class="hljs-variable">$post</span><span class="hljs-variable">-&gt;ID</span>.<span class="hljs-string">'" value=""/&gt;
            &lt;/div&gt;

              &lt;script type="text/javascript"&gt;
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Uploading files</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">var</span> file_frame;

                jQuery(<span class="hljs-string">".replace_media"</span>).live(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( event )</span></span>{

                  event.preventDefault();

                  <span class="hljs-keyword">if</span> ( file_frame ) {
                    file_frame.open();
                    <span class="hljs-keyword">return</span>;
                  }

                  file_frame = wp.media.frames.file_frame = wp.media({
                    title: <span class="hljs-string">"Replace Media"</span>,
                    button: {
                      text: <span class="hljs-string">"Select"</span>
                    },
                    props: {
                      order:<span class="hljs-string">"ASC"</span>
                    },
                    library : {
                      type : <span class="hljs-string">"application"</span>
                    },
                    multiple: <span class="hljs-keyword">false</span>
                  });

                  file_frame.on( <span class="hljs-string">"select"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                    jQuery(<span class="hljs-string">"#replace-media-alert"</span>).remove();

                    attachment = file_frame.state().get(<span class="hljs-string">"selection"</span>).first().toJSON();

                    <span class="hljs-keyword">if</span> ( attachment.id == <span class="hljs-string">'.$post-&gt;ID.'</span>) {
                        jQuery(<span class="hljs-string">"form#post"</span>)
                          .before(<span class="hljs-string">"&lt;div id=\"replace-media-alert\" class=\"updated below-h2\"&gt;&lt;p&gt;The media you selected is the same file as this media.&lt;/p&gt;&lt;/div&gt;"</span>);
                        <span class="hljs-keyword">return</span>;
                    }


                    jQuery(<span class="hljs-string">"#replace-media-input-'. $post-&gt;ID .'"</span>).val(attachment.id)
                    jQuery(<span class="hljs-string">"form#post"</span>).before(<span class="hljs-string">"&lt;div id=\"replace-media-alert\" class=\"error below-h2\"&gt;&lt;p&gt;This media will be &lt;b&gt;permanently replaced&lt;/b&gt; by &lt;b&gt;\""</span>+ attachment.title + <span class="hljs-string">"\"&lt;/b&gt; on "</span> + (jQuery(<span class="hljs-string">"#publish"</span>).val() || <span class="hljs-string">"Save"</span> ) + <span class="hljs-string">"&lt;/p&gt;&lt;/div&gt;"</span>);
                  });

                  file_frame.open();

                });

              &lt;/script&gt;
          <span class="hljs-string">'
      );

    }

      return $fields;
  }

  function uw_save_attachment_slug( $attachment, $post_data )
  {
    if ( strpos( get_post_mime_type($attachment['</span>post_ID<span class="hljs-string">']), '</span>application/<span class="hljs-string">') !== false &amp;&amp;
          !empty($attachment['</span>replace_media_for_<span class="hljs-string">'.$attachment['</span>post_ID<span class="hljs-string">']]) ) {

      if ( ! wp_verify_nonce( $attachment['</span>replace-media-nonce<span class="hljs-string">'], '</span>replace-media-<span class="hljs-string">'. $attachment['</span>post_ID<span class="hljs-string">'] ) )
      {
         print '</span>You <span class="hljs-keyword">do</span> not have access to replace the media file<span class="hljs-string">';
         exit;
      }

      $currentMediaID = $attachment['</span>post_ID<span class="hljs-string">'];
      $newMediaID = $attachment['</span>replace_media_for_<span class="hljs-string">'.$currentMediaID];

      if ( $currentMediaID == $newMediaID )
        return;

      $currentMedia = get_attached_file($currentMediaID);
      $newMedia = get_attached_file($newMediaID);

      if ( $newMedia ) {
        copy($newMedia, $currentMedia);
        wp_delete_attachment($newMediaID);
      }

    }

    if ( !empty( $post_data['</span>post_name<span class="hljs-string">'] ) )
        $attachment['</span>post_name<span class="hljs-string">'] = $post_data['</span>post_name<span class="hljs-string">'];
    return $attachment;
  }

}

</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
