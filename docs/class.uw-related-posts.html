<!DOCTYPE html>

<html>
<head>
  <title>class.uw-related-posts.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="404.html">
                404.php
              </a>
            
              
              <a class="source" href="application.html">
                application.php
              </a>
            
              
              <a class="source" href="archive.html">
                archive.php
              </a>
            
              
              <a class="source" href="breadcrumbs.html">
                breadcrumbs.php
              </a>
            
              
              <a class="source" href="comments.html">
                comments.php
              </a>
            
              
              <a class="source" href="content-archive.html">
                content-archive.php
              </a>
            
              
              <a class="source" href="content-image.html">
                content-image.php
              </a>
            
              
              <a class="source" href="content-page.html">
                content-page.php
              </a>
            
              
              <a class="source" href="content-pdf.html">
                content-pdf.php
              </a>
            
              
              <a class="source" href="content.html">
                content.php
              </a>
            
              
              <a class="source" href="footer.html">
                footer.php
              </a>
            
              
              <a class="source" href="functions.html">
                functions.php
              </a>
            
              
              <a class="source" href="header-image.html">
                header-image.php
              </a>
            
              
              <a class="source" href="header.html">
                header.php
              </a>
            
              
              <a class="source" href="image.html">
                image.php
              </a>
            
              
              <a class="source" href="template-functions.html">
                template-functions.php
              </a>
            
              
              <a class="source" href="index.html">
                index.php
              </a>
            
              
              <a class="source" href="uw.html">
                uw.js
              </a>
            
              
              <a class="source" href="menu-mobile.html">
                menu-mobile.php
              </a>
            
              
              <a class="source" href="page.html">
                page.php
              </a>
            
              
              <a class="source" href="search.html">
                search.php
              </a>
            
              
              <a class="source" href="searchform.html">
                searchform.php
              </a>
            
              
              <a class="source" href="class.button-shortcode.html">
                class.button-shortcode.php
              </a>
            
              
              <a class="source" href="class.dropdowns_walker.html">
                class.dropdowns_walker.php
              </a>
            
              
              <a class="source" href="class.filters.html">
                class.filters.php
              </a>
            
              
              <a class="source" href="class.googleapps.html">
                class.googleapps.php
              </a>
            
              
              <a class="source" href="class.images.html">
                class.images.php
              </a>
            
              
              <a class="source" href="class.install.html">
                class.install.php
              </a>
            
              
              <a class="source" href="class.mimes.html">
                class.mimes.php
              </a>
            
              
              <a class="source" href="class.squish_bugs.html">
                class.squish_bugs.php
              </a>
            
              
              <a class="source" href="class.tile-box-shortcode.html">
                class.tile-box-shortcode.php
              </a>
            
              
              <a class="source" href="class.trumba-shortcode.html">
                class.trumba-shortcode.php
              </a>
            
              
              <a class="source" href="class.users.html">
                class.users.php
              </a>
            
              
              <a class="source" href="class.uw-carousel.html">
                class.uw-carousel.php
              </a>
            
              
              <a class="source" href="class.uw-directory.html">
                class.uw-directory.php
              </a>
            
              
              <a class="source" href="class.uw-documentation.html">
                class.uw-documentation.php
              </a>
            
              
              <a class="source" href="class.uw-dropdowns.html">
                class.uw-dropdowns.php
              </a>
            
              
              <a class="source" href="class.uw-enclosure.html">
                class.uw-enclosure.php
              </a>
            
              
              <a class="source" href="class.uw-iframes.html">
                class.uw-iframes.php
              </a>
            
              
              <a class="source" href="class.uw-media-caption.html">
                class.uw-media-caption.php
              </a>
            
              
              <a class="source" href="class.uw-media-credit.html">
                class.uw-media-credit.php
              </a>
            
              
              <a class="source" href="class.uw-oembeds.html">
                class.uw-oembeds.php
              </a>
            
              
              <a class="source" href="class.uw-page-attributes-meta-box.html">
                class.uw-page-attributes-meta-box.php
              </a>
            
              
              <a class="source" href="class.uw-quicklinks.html">
                class.uw-quicklinks.php
              </a>
            
              
              <a class="source" href="class.uw-replace-media.html">
                class.uw-replace-media.php
              </a>
            
              
              <a class="source" href="class.uw-scripts.html">
                class.uw-scripts.php
              </a>
            
              
              <a class="source" href="class.uw-shortcodes.html">
                class.uw-shortcodes.php
              </a>
            
              
              <a class="source" href="class.uw-styles.html">
                class.uw-styles.php
              </a>
            
              
              <a class="source" href="class.uw-tinymce.html">
                class.uw-tinymce.php
              </a>
            
              
              <a class="source" href="class.uw.html">
                class.uw.php
              </a>
            
              
              <a class="source" href="class.youtube-shortcode.html">
                class.youtube-shortcode.php
              </a>
            
              
              <a class="source" href="sidebar.html">
                sidebar.php
              </a>
            
              
              <a class="source" href="template-big-hero.html">
                template-big-hero.php
              </a>
            
              
              <a class="source" href="template-no-hero.html">
                template-no-hero.php
              </a>
            
              
              <a class="source" href="template-no-sidebar.html">
                template-no-sidebar.php
              </a>
            
              
              <a class="source" href="template-no-title.html">
                template-no-title.php
              </a>
            
              
              <a class="source" href="template-small-hero.html">
                template-small-hero.php
              </a>
            
              
              <a class="source" href="thinstrip.html">
                thinstrip.php
              </a>
            
              
              <a class="source" href="class.uw-blogroll.html">
                class.uw-blogroll.php
              </a>
            
              
              <a class="source" href="class.uw-campus-map.html">
                class.uw-campus-map.php
              </a>
            
              
              <a class="source" href="class.uw-intro.html">
                class.uw-intro.php
              </a>
            
              
              <a class="source" href="class.uw-recent-posts.html">
                class.uw-recent-posts.php
              </a>
            
              
              <a class="source" href="class.uw-related-posts.html">
                class.uw-related-posts.php
              </a>
            
              
              <a class="source" href="class.uw-rss.html">
                class.uw-rss.php
              </a>
            
              
              <a class="source" href="class.uw-sidebar.html">
                class.uw-sidebar.php
              </a>
            
              
              <a class="source" href="class.uw-single-image.html">
                class.uw-single-image.php
              </a>
            
              
              <a class="source" href="class.uw-top-posts.html">
                class.uw-top-posts.php
              </a>
            
              
              <a class="source" href="class.uw-twitter.html">
                class.uw-twitter.php
              </a>
            
              
              <a class="source" href="class.uw-widget-visibility.html">
                class.uw-widget-visibility.php
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>class.uw-related-posts.php</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-preprocessor">&lt;?php</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <pre><code>  Name: UW Related Posts
  Description: A widget that shows related posts
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">if</span> ( ! class_exists( <span class="hljs-string">'UW_Widget_Related_Posts'</span>) ) :

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UW_Widget_Related_Posts</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WP_Widget</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Define constants for the widget’s id, title, description and number of related posts to show.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">const</span> ID    = <span class="hljs-string">'uw-widget-related-posts'</span>;
  <span class="hljs-keyword">const</span> TITLE = <span class="hljs-string">'UW Related Posts'</span>;
  <span class="hljs-keyword">const</span> DESC  = <span class="hljs-string">'A widget that shows posts related posts'</span>;
  <span class="hljs-keyword">const</span> ITEMS = <span class="hljs-number">5</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Instantiate the widget and the Jetpack_RelatedPosts class to use for gathering related posts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">UW_Widget_Related_Posts</span><span class="hljs-params">()</span>
  </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Possible paramters to pass to the the <code>get_for_post_id</code> function: <code>size</code>, <code>post_type</code>, <code>has_terms</code>, <code>date_range</code> and <code>exclude_post_ids</code>.</p>
<ul>
<li>By default related posts go back one year</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-comment">/* [todo] make these widget options */</span>
      <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;RelatedPostsOptions</span> = <span class="hljs-keyword">array</span>(
        <span class="hljs-string">'date_range'</span> =&gt; <span class="hljs-keyword">array</span>( <span class="hljs-string">'from'</span> =&gt; strtotime(<span class="hljs-string">'last year'</span>) , <span class="hljs-string">'to'</span> =&gt; time() )
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Instantiate the Jetpack_RelatedPosts class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      $this-&gt;RelatedPosts = Jetpack_RelatedPosts::init(); //get_current_blog_id() , Jetpack_Options::get_option( 'id' ) );

      parent::WP_Widget(
        $id      = self::ID,
        $name    = self::TITLE,
        $options = array(
          'description' =&gt; self::DESC,
          'classname'   =&gt; self::ID
        )
      );

  }

  function widget( $args, $instance )
  {
    extract( $args );
    extract( $instance );

    $title = apply_filters( 'widget_title', $title );
    $posts = $this-&gt;RelatedPosts-&gt;get_for_post_id( get_the_ID(), $this-&gt;RelatedPostsOptions );
    $posts = $this-&gt;convertToObject( $posts );

    echo $before_widget;

    ?&gt;

    &lt;?php if ( ! empty( $title ) ) echo $before_title . $title . $after_title; ?&gt;

    &lt;ul class="related-posts"&gt;

    &lt;?php foreach ( $posts as $post ) : ?&gt;

          &lt;li&gt;

            &lt;a class="widget-thumbnail" href="&lt;?php echo get_the_permalink( $post-&gt;id ) ?&gt;" title="&lt;?php echo esc_attr( get_the_title( $post-&gt;id ) ) ?&gt;"&gt;

            &lt;?php if ( has_post_thumbnail( $post-&gt;id ) ) : ?&gt;

              &lt;?php echo get_the_post_thumbnail( $post-&gt;id, 'thumbnail' ); ?&gt;

            &lt;?php endif; ?&gt;

            &lt;a class="widget-link" href="&lt;?php echo get_the_permalink( $post-&gt;id ) ?&gt;" title="&lt;?php echo esc_attr( get_the_title( $post-&gt;id ) ) ?&gt;"&gt;
              &lt;?php echo get_the_title( $post-&gt;id ) ?&gt;
            &lt;/a&gt;

            &lt;small&gt;&lt;?php echo get_the_time( get_option( 'date_format' ), $post-&gt;id ) ?&gt;&lt;/small&gt;

          &lt;/li&gt;

    &lt;?php endforeach; ?&gt;

    &lt;/ul&gt;

    &lt;?php

    echo $after_widget;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Save updated settings for the widget.
There is only one setting for now: <code>title</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">( <span class="hljs-variable">$new_instance</span>, <span class="hljs-variable">$old_instance</span> )</span>
  </span>{
    <span class="hljs-variable">$instance</span>[<span class="hljs-string">'title'</span>] = (String) <span class="hljs-variable">$new_instance</span>[<span class="hljs-string">'title'</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$instance</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The form for submitting changes to the widget.
Only one field exists <code>title</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">form</span><span class="hljs-params">( <span class="hljs-variable">$instance</span> )</span>
  </span>{
    extract( <span class="hljs-variable">$instance</span> );
    <span class="hljs-variable">$title</span> = <span class="hljs-variable">$title</span> ? <span class="hljs-variable">$title</span> : <span class="hljs-keyword">self</span>::TITLE;
    <span class="hljs-preprocessor">?&gt;</span>

    &lt;p&gt;

      &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">"&lt;?php echo $this-&gt;get_field_name( 'title' ) ?&gt;"</span>&gt; <span class="hljs-preprocessor">&lt;?php</span> _e( <span class="hljs-string">'Title:'</span> )  <span class="hljs-preprocessor">?&gt;</span> &lt;/label&gt;

      &lt;input name=<span class="hljs-string">"&lt;?php echo $this-&gt;get_field_name( 'title' ) ?&gt;"</span> id=<span class="hljs-string">"&lt;?php echo $this-&gt;get_field_id( 'title' ) ?&gt;"</span> type=<span class="hljs-string">"text"</span> value=<span class="hljs-string">"&lt;?php echo $title ?&gt;"</span>/&gt;

    &lt;/p&gt;

  <span class="hljs-preprocessor">&lt;?php</span>

	}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>A custom function that converts a multidimensional array to an array of objects for cleaner notation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">convertToObject</span><span class="hljs-params">( <span class="hljs-variable">$array</span> )</span>
  </span>{
    <span class="hljs-keyword">return</span> json_decode( json_encode( <span class="hljs-variable">$array</span> ) );
  }

}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>A class that will instantiate the widget only if Jetpack is installed and the function <code>get_for_post_id</code> exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UW_Related_Posts</span>
</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The priority needed to remove the actions Jetpack_RelatedPosts adds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">const</span> PRIORITY = <span class="hljs-number">100</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">UW_Related_Posts</span><span class="hljs-params">()</span>
  </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Register the widget.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    add_action( <span class="hljs-string">'widgets_init'</span>, <span class="hljs-keyword">array</span>( <span class="hljs-variable">$this</span>, <span class="hljs-string">'register'</span> ) );</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Remove the actions Jetpack_RelatedPosts adds.
The priority of <code>100</code> is necessary to ensure that Jetpack_RelatedPosts has already added its actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    add_action( <span class="hljs-string">'plugins_loaded'</span>, <span class="hljs-keyword">array</span>( <span class="hljs-variable">$this</span>, <span class="hljs-string">'remove_related_posts_from_content'</span>), <span class="hljs-keyword">self</span>::PRIORITY );

  }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Only register the widget if Jetpack is installed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span>
  </span>{
    <span class="hljs-keyword">if</span> ( <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;jetpackInstalled</span>() )
      register_widget( <span class="hljs-string">'UW_Widget_Related_Posts'</span> );
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Remove the related posts javscript, css and html from the content.
This takes advantage of the PHP singleton pattern in <code>Jetpack_RelatedPosts::init()</code>.
Calling it doesn’t reinstantiate the class but rather returns the already instantiated instance
which we use to remove it’s actions and filters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">remove_related_posts_from_content</span><span class="hljs-params">()</span>
  </span>{
    <span class="hljs-keyword">if</span> ( <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;jetpackInstalled</span>() )
    {
      <span class="hljs-variable">$jprp</span> = Jetpack_RelatedPosts::init();
      remove_action( <span class="hljs-string">'wp'</span>, <span class="hljs-keyword">array</span>( <span class="hljs-variable">$jprp</span>, <span class="hljs-string">'action_frontend_init'</span> ), <span class="hljs-number">10</span> );
      remove_filter( <span class="hljs-string">'the_content'</span>, <span class="hljs-keyword">array</span>( <span class="hljs-variable">$jprp</span>, <span class="hljs-string">'filter_add_target_to_dom'</span> ), <span class="hljs-number">40</span> );
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Check to see if Jetpack is installed by seeing if the class <code>Jetpack_RelatedPosts</code> exists.
The <code>get_for_post_id</code> function is provided by the Jetpack_RelatedPosts class and is used to gather related post</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">jetpackInstalled</span><span class="hljs-params">()</span>
  </span>{
    <span class="hljs-keyword">return</span> class_exists(<span class="hljs-string">'Jetpack_RelatedPosts'</span>);
  }

}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Instantiate the plugin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">new</span> UW_Related_Posts;

<span class="hljs-keyword">endif</span>;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
