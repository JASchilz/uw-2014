<!DOCTYPE html>

<html>
<head>
  <title>timthumb.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="404.html">
                404.php
              </a>
            
              
              <a class="source" href="application.html">
                application.php
              </a>
            
              
              <a class="source" href="breadcrumbs.html">
                breadcrumbs.php
              </a>
            
              
              <a class="source" href="comments.html">
                comments.php
              </a>
            
              
              <a class="source" href="content-image.html">
                content-image.php
              </a>
            
              
              <a class="source" href="content-page.html">
                content-page.php
              </a>
            
              
              <a class="source" href="content-pdf.html">
                content-pdf.php
              </a>
            
              
              <a class="source" href="content.html">
                content.php
              </a>
            
              
              <a class="source" href="footer.html">
                footer.php
              </a>
            
              
              <a class="source" href="functions.html">
                functions.php
              </a>
            
              
              <a class="source" href="header.html">
                header.php
              </a>
            
              
              <a class="source" href="image.html">
                image.php
              </a>
            
              
              <a class="source" href="index.html">
                index.php
              </a>
            
              
              <a class="source" href="uw.html">
                uw.js
              </a>
            
              
              <a class="source" href="page.html">
                page.php
              </a>
            
              
              <a class="source" href="searchform.html">
                searchform.php
              </a>
            
              
              <a class="source" href="class.button-shortcode.html">
                class.button-shortcode.php
              </a>
            
              
              <a class="source" href="class.dropdowns_walker.html">
                class.dropdowns_walker.php
              </a>
            
              
              <a class="source" href="class.filters.html">
                class.filters.php
              </a>
            
              
              <a class="source" href="class.googleapps.html">
                class.googleapps.php
              </a>
            
              
              <a class="source" href="class.images.html">
                class.images.php
              </a>
            
              
              <a class="source" href="class.install.html">
                class.install.php
              </a>
            
              
              <a class="source" href="class.mimes.html">
                class.mimes.php
              </a>
            
              
              <a class="source" href="class.squish_bugs.html">
                class.squish_bugs.php
              </a>
            
              
              <a class="source" href="class.tile-box-shortcode.html">
                class.tile-box-shortcode.php
              </a>
            
              
              <a class="source" href="class.users.html">
                class.users.php
              </a>
            
              
              <a class="source" href="class.uw-directory.html">
                class.uw-directory.php
              </a>
            
              
              <a class="source" href="class.uw-documentation.html">
                class.uw-documentation.php
              </a>
            
              
              <a class="source" href="class.uw-dropdowns.html">
                class.uw-dropdowns.php
              </a>
            
              
              <a class="source" href="class.uw-enclosure.html">
                class.uw-enclosure.php
              </a>
            
              
              <a class="source" href="class.uw-iframes.html">
                class.uw-iframes.php
              </a>
            
              
              <a class="source" href="class.uw-media-caption.html">
                class.uw-media-caption.php
              </a>
            
              
              <a class="source" href="class.uw-media-credit.html">
                class.uw-media-credit.php
              </a>
            
              
              <a class="source" href="class.uw-oembeds.html">
                class.uw-oembeds.php
              </a>
            
              
              <a class="source" href="class.uw-page-attributes-meta-box.html">
                class.uw-page-attributes-meta-box.php
              </a>
            
              
              <a class="source" href="class.uw-quicklinks.html">
                class.uw-quicklinks.php
              </a>
            
              
              <a class="source" href="class.uw-replace-media.html">
                class.uw-replace-media.php
              </a>
            
              
              <a class="source" href="class.uw-scripts.html">
                class.uw-scripts.php
              </a>
            
              
              <a class="source" href="class.uw-shortcodes.html">
                class.uw-shortcodes.php
              </a>
            
              
              <a class="source" href="class.uw-styles.html">
                class.uw-styles.php
              </a>
            
              
              <a class="source" href="class.uw-tinymce.html">
                class.uw-tinymce.php
              </a>
            
              
              <a class="source" href="class.uw.html">
                class.uw.php
              </a>
            
              
              <a class="source" href="class.youtube-shortcode.html">
                class.youtube-shortcode.php
              </a>
            
              
              <a class="source" href="sidebar.html">
                sidebar.php
              </a>
            
              
              <a class="source" href="thinstrip.html">
                thinstrip.php
              </a>
            
              
              <a class="source" href="timthumb.html">
                timthumb.php
              </a>
            
              
              <a class="source" href="class.uw-blogroll.html">
                class.uw-blogroll.php
              </a>
            
              
              <a class="source" href="class.uw-campus-map.html">
                class.uw-campus-map.php
              </a>
            
              
              <a class="source" href="class.uw-intro.html">
                class.uw-intro.php
              </a>
            
              
              <a class="source" href="class.uw-related-posts.html">
                class.uw-related-posts.php
              </a>
            
              
              <a class="source" href="class.uw-rss.html">
                class.uw-rss.php
              </a>
            
              
              <a class="source" href="class.uw-sidebar.html">
                class.uw-sidebar.php
              </a>
            
              
              <a class="source" href="class.uw-single-image.html">
                class.uw-single-image.php
              </a>
            
              
              <a class="source" href="class.uw-top-posts.html">
                class.uw-top-posts.php
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>timthumb.php</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-comment">/**
 * TimThumb by Ben Gillbanks and Mark Maunder
 * Based on work done by Tim McDaniels and Darren Hoyt
 * http://code.google.com/p/timthumb/
 * 
 * GNU General Public License, version 2
 * http://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * Examples and documentation available on the project homepage
 * http://www.binarymoon.co.uk/projects/timthumb/
 * 
 * $Rev$
 */</span>

<span class="hljs-comment">/*
 * --- TimThumb CONFIGURATION ---
 * To edit the configs it is best to create a file called timthumb-config.php
 * and define variables you want to customize in there. It will automatically be
 * loaded by timthumb. This will save you having to re-edit these variables
 * everytime you download a new version
*/</span>
define (<span class="hljs-string">'VERSION'</span>, <span class="hljs-string">'2.8.14'</span>);																		<span class="hljs-comment">// Version of this script </span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Load a config file if it exists. Otherwise, use the values below</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>( file_exists(dirname(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-string">'/timthumb-config.php'</span>))	<span class="hljs-keyword">require_once</span>(<span class="hljs-string">'timthumb-config.php'</span>);
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'DEBUG_ON'</span>) )					define (<span class="hljs-string">'DEBUG_ON'</span>, <span class="hljs-keyword">false</span>);								<span class="hljs-comment">// Enable debug logging to web server error log (STDERR)</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'DEBUG_LEVEL'</span>) )				define (<span class="hljs-string">'DEBUG_LEVEL'</span>, <span class="hljs-number">1</span>);								<span class="hljs-comment">// Debug level 1 is less noisy and 3 is the most noisy</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'MEMORY_LIMIT'</span>) )				define (<span class="hljs-string">'MEMORY_LIMIT'</span>, <span class="hljs-string">'30M'</span>);							<span class="hljs-comment">// Set PHP memory limit</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'BLOCK_EXTERNAL_LEECHERS'</span>) ) 	define (<span class="hljs-string">'BLOCK_EXTERNAL_LEECHERS'</span>, <span class="hljs-keyword">false</span>);				<span class="hljs-comment">// If the image or webshot is being loaded on an external site, display a red "No Hotlinking" gif.</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'DISPLAY_ERROR_MESSAGES'</span>) )	define (<span class="hljs-string">'DISPLAY_ERROR_MESSAGES'</span>, <span class="hljs-keyword">true</span>);				<span class="hljs-comment">// Display error messages. Set to false to turn off errors (good for production websites)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Image fetching and caching</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'ALLOW_EXTERNAL'</span>) )			define (<span class="hljs-string">'ALLOW_EXTERNAL'</span>, <span class="hljs-keyword">false</span>);						<span class="hljs-comment">// Allow image fetching from external websites. Will check against ALLOWED_SITES if ALLOW_ALL_EXTERNAL_SITES is false</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'ALLOW_ALL_EXTERNAL_SITES'</span>) ) 	define (<span class="hljs-string">'ALLOW_ALL_EXTERNAL_SITES'</span>, <span class="hljs-keyword">false</span>);				<span class="hljs-comment">// Less secure. </span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'FILE_CACHE_ENABLED'</span>) ) 		define (<span class="hljs-string">'FILE_CACHE_ENABLED'</span>, <span class="hljs-keyword">TRUE</span>);					<span class="hljs-comment">// Should we store resized/modified images on disk to speed things up?</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'FILE_CACHE_TIME_BETWEEN_CLEANS'</span>))	define (<span class="hljs-string">'FILE_CACHE_TIME_BETWEEN_CLEANS'</span>, <span class="hljs-number">86400</span>);	<span class="hljs-comment">// How often the cache is cleaned </span>

<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'FILE_CACHE_MAX_FILE_AGE'</span>) ) 	define (<span class="hljs-string">'FILE_CACHE_MAX_FILE_AGE'</span>, <span class="hljs-number">86400</span>);				<span class="hljs-comment">// How old does a file have to be to be deleted from the cache</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'FILE_CACHE_SUFFIX'</span>) ) 		define (<span class="hljs-string">'FILE_CACHE_SUFFIX'</span>, <span class="hljs-string">'.timthumb.txt'</span>);			<span class="hljs-comment">// What to put at the end of all files in the cache directory so we can identify them</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'FILE_CACHE_PREFIX'</span>) ) 		define (<span class="hljs-string">'FILE_CACHE_PREFIX'</span>, <span class="hljs-string">'timthumb'</span>);				<span class="hljs-comment">// What to put at the beg of all files in the cache directory so we can identify them</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'FILE_CACHE_DIRECTORY'</span>) ) 		define (<span class="hljs-string">'FILE_CACHE_DIRECTORY'</span>, <span class="hljs-string">'./cache'</span>);				<span class="hljs-comment">// Directory where images are cached. Left blank it will use the system temporary directory (which is better for security)</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'MAX_FILE_SIZE'</span>) )				define (<span class="hljs-string">'MAX_FILE_SIZE'</span>, <span class="hljs-number">10485760</span>);						<span class="hljs-comment">// 10 Megs is 10485760. This is the max internal or external file size that we'll process.  </span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'CURL_TIMEOUT'</span>) )				define (<span class="hljs-string">'CURL_TIMEOUT'</span>, <span class="hljs-number">20</span>);							<span class="hljs-comment">// Timeout duration for Curl. This only applies if you have Curl installed and aren't using PHP's default URL fetching mechanism.</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WAIT_BETWEEN_FETCH_ERRORS'</span>) )	define (<span class="hljs-string">'WAIT_BETWEEN_FETCH_ERRORS'</span>, <span class="hljs-number">3600</span>);				<span class="hljs-comment">// Time to wait between errors fetching remote file</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Browser caching</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'BROWSER_CACHE_MAX_AGE'</span>) ) 	define (<span class="hljs-string">'BROWSER_CACHE_MAX_AGE'</span>, <span class="hljs-number">864000</span>);				<span class="hljs-comment">// Time to cache in the browser</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'BROWSER_CACHE_DISABLE'</span>) ) 	define (<span class="hljs-string">'BROWSER_CACHE_DISABLE'</span>, <span class="hljs-keyword">false</span>);				<span class="hljs-comment">// Use for testing if you want to disable all browser caching</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Image size and defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'MAX_WIDTH'</span>) )					define (<span class="hljs-string">'MAX_WIDTH'</span>, <span class="hljs-number">1500</span>);								<span class="hljs-comment">// Maximum image width</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'MAX_HEIGHT'</span>) )				define (<span class="hljs-string">'MAX_HEIGHT'</span>, <span class="hljs-number">1500</span>);							<span class="hljs-comment">// Maximum image height</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'NOT_FOUND_IMAGE'</span>) )			define (<span class="hljs-string">'NOT_FOUND_IMAGE'</span>, <span class="hljs-string">''</span>);							<span class="hljs-comment">// Image to serve if any 404 occurs </span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'ERROR_IMAGE'</span>) )				define (<span class="hljs-string">'ERROR_IMAGE'</span>, <span class="hljs-string">''</span>);								<span class="hljs-comment">// Image to serve if an error occurs instead of showing error message </span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'PNG_IS_TRANSPARENT'</span>) )		define (<span class="hljs-string">'PNG_IS_TRANSPARENT'</span>, <span class="hljs-keyword">FALSE</span>);					<span class="hljs-comment">// Define if a png image should have a transparent background color. Use False value if you want to display a custom coloured canvas_colour </span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'DEFAULT_Q'</span>) )					define (<span class="hljs-string">'DEFAULT_Q'</span>, <span class="hljs-number">90</span>);								<span class="hljs-comment">// Default image quality. Allows overrid in timthumb-config.php</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'DEFAULT_ZC'</span>) )				define (<span class="hljs-string">'DEFAULT_ZC'</span>, <span class="hljs-number">1</span>);								<span class="hljs-comment">// Default zoom/crop setting. Allows overrid in timthumb-config.php</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'DEFAULT_F'</span>) )					define (<span class="hljs-string">'DEFAULT_F'</span>, <span class="hljs-string">''</span>);								<span class="hljs-comment">// Default image filters. Allows overrid in timthumb-config.php</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'DEFAULT_S'</span>) )					define (<span class="hljs-string">'DEFAULT_S'</span>, <span class="hljs-number">0</span>);								<span class="hljs-comment">// Default sharpen value. Allows overrid in timthumb-config.php</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'DEFAULT_CC'</span>) )				define (<span class="hljs-string">'DEFAULT_CC'</span>, <span class="hljs-string">'ffffff'</span>);						<span class="hljs-comment">// Default canvas colour. Allows overrid in timthumb-config.php</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'DEFAULT_WIDTH'</span>) )				define (<span class="hljs-string">'DEFAULT_WIDTH'</span>, <span class="hljs-number">100</span>);							<span class="hljs-comment">// Default thumbnail width. Allows overrid in timthumb-config.php</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'DEFAULT_HEIGHT'</span>) )			define (<span class="hljs-string">'DEFAULT_HEIGHT'</span>, <span class="hljs-number">100</span>);							<span class="hljs-comment">// Default thumbnail height. Allows overrid in timthumb-config.php</span>

<span class="hljs-comment">/**
 * Additional Parameters:
 * LOCAL_FILE_BASE_DIRECTORY = Override the DOCUMENT_ROOT. This is best used in timthumb-config.php
 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Image compression is enabled if either of these point to valid paths</p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>These are now disabled by default because the file sizes of PNGs (and GIFs) are much smaller than we used to generate. 
They only work for PNGs. GIFs and JPEGs are not affected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'OPTIPNG_ENABLED'</span>) ) 		define (<span class="hljs-string">'OPTIPNG_ENABLED'</span>, <span class="hljs-keyword">false</span>);  
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'OPTIPNG_PATH'</span>) ) 			define (<span class="hljs-string">'OPTIPNG_PATH'</span>, <span class="hljs-string">'/usr/bin/optipng'</span>); <span class="hljs-comment">//This will run first because it gives better compression than pngcrush. </span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'PNGCRUSH_ENABLED'</span>) ) 		define (<span class="hljs-string">'PNGCRUSH_ENABLED'</span>, <span class="hljs-keyword">false</span>); 
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'PNGCRUSH_PATH'</span>) ) 		define (<span class="hljs-string">'PNGCRUSH_PATH'</span>, <span class="hljs-string">'/usr/bin/pngcrush'</span>); <span class="hljs-comment">//This will only run if OPTIPNG_PATH is not set or is not valid</span>

<span class="hljs-comment">/*
	-------====Website Screenshots configuration - BETA====-------
	
	If you just want image thumbnails and don't want website screenshots, you can safely leave this as is.	
	
	If you would like to get website screenshots set up, you will need root access to your own server.

	Enable ALLOW_ALL_EXTERNAL_SITES so you can fetch any external web page. This is more secure now that we're using a non-web folder for cache.
	Enable BLOCK_EXTERNAL_LEECHERS so that your site doesn't generate thumbnails for the whole Internet.

	Instructions to get website screenshots enabled on Ubuntu Linux:

	1. Install Xvfb with the following command: sudo apt-get install subversion libqt4-webkit libqt4-dev g++ xvfb
	2. Go to a directory where you can download some code
	3. Check-out the latest version of CutyCapt with the following command: svn co https://cutycapt.svn.sourceforge.net/svnroot/cutycapt
	4. Compile CutyCapt by doing: cd cutycapt/CutyCapt
	5. qmake
	6. make
	7. cp CutyCapt /usr/local/bin/
	8. Test it by running: xvfb-run --server-args="-screen 0, 1024x768x24" CutyCapt --url="http://markmaunder.com/" --out=test.png
	9. If you get a file called test.png with something in it, it probably worked. Now test the script by accessing it as follows:
	10. http://yoursite.com/path/to/timthumb.php?src=http://markmaunder.com/&amp;webshot=1

	Notes on performance: 
	The first time a webshot loads, it will take a few seconds.
	From then on it uses the regular timthumb caching mechanism with the configurable options above
	and loading will be very fast.

	--ADVANCED USERS ONLY--
	If you'd like a slight speedup (about 25%) and you know Linux, you can run the following command which will keep Xvfb running in the background.
	nohup Xvfb :100 -ac -nolisten tcp -screen 0, 1024x768x24 &gt; /dev/null 2&gt;&amp;1 &amp;
	Then set WEBSHOT_XVFB_RUNNING = true below. This will save your server having to fire off a new Xvfb server and shut it down every time a new shot is generated. 
	You will need to take responsibility for keeping Xvfb running in case it crashes. (It seems pretty stable)
	You will also need to take responsibility for server security if you're running Xvfb as root. 


*/</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_ENABLED'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_ENABLED'</span>, <span class="hljs-keyword">false</span>);			<span class="hljs-comment">//Beta feature. Adding webshot=1 to your query string will cause the script to return a browser screenshot rather than try to fetch an image.</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_CUTYCAPT'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_CUTYCAPT'</span>, <span class="hljs-string">'/usr/local/bin/CutyCapt'</span>); <span class="hljs-comment">//The path to CutyCapt. </span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_XVFB'</span>) ) 		define (<span class="hljs-string">'WEBSHOT_XVFB'</span>, <span class="hljs-string">'/usr/bin/xvfb-run'</span>);		<span class="hljs-comment">//The path to the Xvfb server</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_SCREEN_X'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_SCREEN_X'</span>, <span class="hljs-string">'1024'</span>);			<span class="hljs-comment">//1024 works ok</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_SCREEN_Y'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_SCREEN_Y'</span>, <span class="hljs-string">'768'</span>);			<span class="hljs-comment">//768 works ok</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_COLOR_DEPTH'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_COLOR_DEPTH'</span>, <span class="hljs-string">'24'</span>);			<span class="hljs-comment">//I haven't tested anything besides 24</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_IMAGE_FORMAT'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_IMAGE_FORMAT'</span>, <span class="hljs-string">'png'</span>);			<span class="hljs-comment">//png is about 2.5 times the size of jpg but is a LOT better quality</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_TIMEOUT'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_TIMEOUT'</span>, <span class="hljs-string">'20'</span>);			<span class="hljs-comment">//Seconds to wait for a webshot</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_USER_AGENT'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_USER_AGENT'</span>, <span class="hljs-string">"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.9.2.18) Gecko/20110614 Firefox/3.6.18"</span>); <span class="hljs-comment">//I hate to do this, but a non-browser robot user agent might not show what humans see. So we pretend to be Firefox</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_JAVASCRIPT_ON'</span>) ) define (<span class="hljs-string">'WEBSHOT_JAVASCRIPT_ON'</span>, <span class="hljs-keyword">true</span>);			<span class="hljs-comment">//Setting to false might give you a slight speedup and block ads. But it could cause other issues.</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_JAVA_ON'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_JAVA_ON'</span>, <span class="hljs-keyword">false</span>);			<span class="hljs-comment">//Have only tested this as fase</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_PLUGINS_ON'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_PLUGINS_ON'</span>, <span class="hljs-keyword">true</span>);			<span class="hljs-comment">//Enable flash and other plugins</span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_PROXY'</span>) ) 	define (<span class="hljs-string">'WEBSHOT_PROXY'</span>, <span class="hljs-string">''</span>);				<span class="hljs-comment">//In case you're behind a proxy server. </span>
<span class="hljs-keyword">if</span>(! defined(<span class="hljs-string">'WEBSHOT_XVFB_RUNNING'</span>) )	define (<span class="hljs-string">'WEBSHOT_XVFB_RUNNING'</span>, <span class="hljs-keyword">false</span>);			<span class="hljs-comment">//ADVANCED: Enable this if you've got Xvfb running in the background.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>If ALLOW_EXTERNAL is true and ALLOW_ALL_EXTERNAL_SITES is false, then external images will only be fetched from these domains and their subdomains. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>(! <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$ALLOWED_SITES</span>)){
	<span class="hljs-variable">$ALLOWED_SITES</span> = <span class="hljs-keyword">array</span> (
		<span class="hljs-string">'flickr.com'</span>,
		<span class="hljs-string">'staticflickr.com'</span>,
		<span class="hljs-string">'picasa.com'</span>,
		<span class="hljs-string">'img.youtube.com'</span>,
		<span class="hljs-string">'upload.wikimedia.org'</span>,
		<span class="hljs-string">'photobucket.com'</span>,
		<span class="hljs-string">'imgur.com'</span>,
		<span class="hljs-string">'imageshack.us'</span>,
		<span class="hljs-string">'tinypic.com'</span>,
	);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="-stop-editing-configuration-here-">——————— STOP EDITING CONFIGURATION HERE ———————</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
timthumb::start();

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">timthumb</span> </span>{
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$src</span> = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$is404</span> = <span class="hljs-keyword">false</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$docRoot</span> = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$lastURLError</span> = <span class="hljs-keyword">false</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$localImage</span> = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$localImageMTime</span> = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$url</span> = <span class="hljs-keyword">false</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$myHost</span> = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$isURL</span> = <span class="hljs-keyword">false</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$cachefile</span> = <span class="hljs-string">''</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$errors</span> = <span class="hljs-keyword">array</span>();
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$toDeletes</span> = <span class="hljs-keyword">array</span>();
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$cacheDirectory</span> = <span class="hljs-string">''</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$startTime</span> = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$lastBenchTime</span> = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$cropTop</span> = <span class="hljs-keyword">false</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$salt</span> = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$fileCacheVersion</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">//Generally if timthumb.php is modifed (upgraded) then the salt changes and all cache files are recreated. This is a backup mechanism to force regen.</span>
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$filePrependSecurityBlock</span> = <span class="hljs-string">"&lt;?php die('Execution denied!'); //"</span>; <span class="hljs-comment">//Designed to have three letter mime type, space, question mark and greater than symbol appended. 6 bytes total.</span>
	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-variable">$curlDataWritten</span> = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-variable">$curlFH</span> = <span class="hljs-keyword">false</span>;
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span>{
		<span class="hljs-variable">$tim</span> = <span class="hljs-keyword">new</span> timthumb();
		<span class="hljs-variable">$tim</span><span class="hljs-variable">-&gt;handleErrors</span>();
		<span class="hljs-variable">$tim</span><span class="hljs-variable">-&gt;securityChecks</span>();
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$tim</span><span class="hljs-variable">-&gt;tryBrowserCache</span>()){
			<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);
		}
		<span class="hljs-variable">$tim</span><span class="hljs-variable">-&gt;handleErrors</span>();
		<span class="hljs-keyword">if</span>(FILE_CACHE_ENABLED &amp;&amp; <span class="hljs-variable">$tim</span><span class="hljs-variable">-&gt;tryServerCache</span>()){
			<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);
		}
		<span class="hljs-variable">$tim</span><span class="hljs-variable">-&gt;handleErrors</span>();
		<span class="hljs-variable">$tim</span><span class="hljs-variable">-&gt;run</span>();
		<span class="hljs-variable">$tim</span><span class="hljs-variable">-&gt;handleErrors</span>();
		<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);
	}
	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">global</span> <span class="hljs-variable">$ALLOWED_SITES</span>;
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;startTime</span> = microtime(<span class="hljs-keyword">true</span>);
		date_default_timezone_set(<span class="hljs-string">'UTC'</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Starting new request from "</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;getIP</span>() . <span class="hljs-string">" to "</span> . <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_URI'</span>]);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;calcDocRoot</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>On windows systems I’m assuming fileinode returns an empty string or a number that doesn’t change. Check this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;salt</span> = @filemtime(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-string">'-'</span> . @fileinode(<span class="hljs-keyword">__FILE__</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Salt is: "</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;salt</span>);
		<span class="hljs-keyword">if</span>(FILE_CACHE_DIRECTORY){
			<span class="hljs-keyword">if</span>(! is_dir(FILE_CACHE_DIRECTORY)){
				@mkdir(FILE_CACHE_DIRECTORY);
				<span class="hljs-keyword">if</span>(! is_dir(FILE_CACHE_DIRECTORY)){
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not create the file cache directory."</span>);
					<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
				}
			}
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span> = FILE_CACHE_DIRECTORY;
			<span class="hljs-keyword">if</span> (!touch(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span> . <span class="hljs-string">'/index.html'</span>)) {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not create the index.html file - to fix this create an empty file named index.html file in the cache directory."</span>);
			}
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span> = sys_get_temp_dir();
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Clean the cache before we do anything because we don’t want the first visitor after FILE_CACHE_TIME_BETWEEN_CLEANS expires to get a stale image. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cleanCache</span>();
		
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;myHost</span> = preg_replace(<span class="hljs-string">'/^www\./i'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_HOST'</span>]);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'src'</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;url</span> = parse_url(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span> = preg_replace(<span class="hljs-string">'/https?:\/\/(?:www\.)?'</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;myHost</span> . <span class="hljs-string">'/i'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span>);
		
		<span class="hljs-keyword">if</span>(strlen(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span>) &lt;= <span class="hljs-number">3</span>){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"No image specified"</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
		<span class="hljs-keyword">if</span>(BLOCK_EXTERNAL_LEECHERS &amp;&amp; array_key_exists(<span class="hljs-string">'HTTP_REFERER'</span>, <span class="hljs-variable">$_SERVER</span>) &amp;&amp; (! preg_match(<span class="hljs-string">'/^https?:\/\/(?:www\.)?'</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;myHost</span> . <span class="hljs-string">'(?:$|\/)/i'</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_REFERER'</span>]))){</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>base64 encoded red image that says ‘no hotlinkers’
nothing to worry about! :)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-variable">$imgData</span> = base64_decode(<span class="hljs-string">"R0lGODlhUAAMAIAAAP8AAP///yH5BAAHAP8ALAAAAABQAAwAAAJpjI+py+0Po5y0OgAMjjv01YUZ\nOGplhWXfNa6JCLnWkXplrcBmW+spbwvaVr/cDyg7IoFC2KbYVC2NQ5MQ4ZNao9Ynzjl9ScNYpneb\nDULB3RP6JuPuaGfuuV4fumf8PuvqFyhYtjdoeFgAADs="</span>);
			header(<span class="hljs-string">'Content-Type: image/gif'</span>);
			header(<span class="hljs-string">'Content-Length: '</span> . strlen(<span class="hljs-variable">$imgData</span>));
			header(<span class="hljs-string">'Cache-Control: no-store, no-cache, must-revalidate, max-age=0'</span>);
			header(<span class="hljs-string">"Pragma: no-cache"</span>);
			header(<span class="hljs-string">'Expires: '</span> . gmdate (<span class="hljs-string">'D, d M Y H:i:s'</span>, time()));
			<span class="hljs-keyword">echo</span> <span class="hljs-variable">$imgData</span>;
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);
		}
		<span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/^https?:\/\/[^\/]+/i'</span>, <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Is a request for an external URL: "</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span>);
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;isURL</span> = <span class="hljs-keyword">true</span>;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Is a request for an internal file: "</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span>);
		}
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;isURL</span> &amp;&amp; (! ALLOW_EXTERNAL)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"You are not allowed to fetch images from an external website."</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;isURL</span>){
			<span class="hljs-keyword">if</span>(ALLOW_ALL_EXTERNAL_SITES){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Fetching from all external sites is enabled."</span>);
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Fetching only from selected external sites is enabled."</span>);
				<span class="hljs-variable">$allowed</span> = <span class="hljs-keyword">false</span>;
				<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$ALLOWED_SITES</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$site</span>){
					<span class="hljs-keyword">if</span> ((strtolower(substr(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;url</span>[<span class="hljs-string">'host'</span>],-strlen(<span class="hljs-variable">$site</span>)-<span class="hljs-number">1</span>)) === strtolower(<span class="hljs-string">".$site"</span>)) || (strtolower(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;url</span>[<span class="hljs-string">'host'</span>])===strtolower(<span class="hljs-variable">$site</span>))) {
						<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"URL hostname {$this-&gt;url['host']} matches $site so allowing."</span>);
						<span class="hljs-variable">$allowed</span> = <span class="hljs-keyword">true</span>;
					}
				}
				<span class="hljs-keyword">if</span>(! <span class="hljs-variable">$allowed</span>){
					<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"You may not fetch images from that site. To enable this site in timthumb, you can either add it to \$ALLOWED_SITES and set ALLOW_EXTERNAL=true. Or you can set ALLOW_ALL_EXTERNAL_SITES=true, depending on your security needs."</span>);
				}
			}
		}

		<span class="hljs-variable">$cachePrefix</span> = (<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;isURL</span> ? <span class="hljs-string">'_ext_'</span> : <span class="hljs-string">'_int_'</span>);
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;isURL</span>){
			<span class="hljs-variable">$arr</span> = explode(<span class="hljs-string">'&amp;'</span>, <span class="hljs-variable">$_SERVER</span> [<span class="hljs-string">'QUERY_STRING'</span>]);
			asort(<span class="hljs-variable">$arr</span>);
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span> . <span class="hljs-string">'/'</span> . FILE_CACHE_PREFIX . <span class="hljs-variable">$cachePrefix</span> . md5(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;salt</span> . implode(<span class="hljs-string">''</span>, <span class="hljs-variable">$arr</span>) . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;fileCacheVersion</span>) . FILE_CACHE_SUFFIX;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;localImage</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;getLocalImagePath</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span>);
			<span class="hljs-keyword">if</span>(! <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;localImage</span>){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Could not find the local image: {$this-&gt;localImage}"</span>);
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not find the internal image you specified."</span>);
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;set404</span>();
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			}
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Local image path is {$this-&gt;localImage}"</span>);
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;localImageMTime</span> = @filemtime(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;localImage</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>We include the mtime of the local file in case in changes on disk.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span> . <span class="hljs-string">'/'</span> . FILE_CACHE_PREFIX . <span class="hljs-variable">$cachePrefix</span> . md5(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;salt</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;localImageMTime</span> . <span class="hljs-variable">$_SERVER</span> [<span class="hljs-string">'QUERY_STRING'</span>] . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;fileCacheVersion</span>) . FILE_CACHE_SUFFIX;
		}
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Cache file is: "</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
	}
	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;toDeletes</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$del</span>){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Deleting temp file $del"</span>);
			@unlink(<span class="hljs-variable">$del</span>);
		}
	}
	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;isURL</span>){
			<span class="hljs-keyword">if</span>(! ALLOW_EXTERNAL){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Got a request for an external image but ALLOW_EXTERNAL is disabled so returning error msg."</span>);
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"You are not allowed to fetch images from an external website."</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			}
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Got request for external image. Starting serveExternalImage."</span>);
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'webshot'</span>)){
				<span class="hljs-keyword">if</span>(WEBSHOT_ENABLED){
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"webshot param is set, so we're going to take a webshot."</span>);
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;serveWebshot</span>();
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"You added the webshot parameter but webshots are disabled on this server. You need to set WEBSHOT_ENABLED == true to enable webshots."</span>);
				}
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"webshot is NOT set so we're going to try to fetch a regular image."</span>);
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;serveExternalImage</span>();

			}
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Got request for internal image. Starting serveInternalImage()"</span>);
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;serveInternalImage</span>();
		}
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleErrors</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;haveErrors</span>()){ 
			<span class="hljs-keyword">if</span>(NOT_FOUND_IMAGE &amp;&amp; <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;is404</span>()){
				<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;serveImg</span>(NOT_FOUND_IMAGE)){
					<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Additionally, the 404 image that is configured could not be found or there was an error serving it."</span>);
				}
			}
			<span class="hljs-keyword">if</span>(ERROR_IMAGE){
				<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;serveImg</span>(ERROR_IMAGE)){
					<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Additionally, the error image that is configured could not be found or there was an error serving it."</span>);
				}
			}
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;serveErrors</span>(); 
			<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>); 
		}
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tryBrowserCache</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">if</span>(BROWSER_CACHE_DISABLE){ <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Browser caching is disabled"</span>); <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>; }
		<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_IF_MODIFIED_SINCE'</span>]) ){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Got a conditional get"</span>);
			<span class="hljs-variable">$mtime</span> = <span class="hljs-keyword">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>We’ve already checked if the real file exists in the constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span>(! is_file(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>)){</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If we don’t have something cached, regenerate the cached image.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			}
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;localImageMTime</span>){
				<span class="hljs-variable">$mtime</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;localImageMTime</span>;
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Local real file's modification time is $mtime"</span>);
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(is_file(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>)){ <span class="hljs-comment">//If it's not a local request then use the mtime of the cached file to determine the 304</span>
				<span class="hljs-variable">$mtime</span> = @filemtime(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Cached file's modification time is $mtime"</span>);
			}
			<span class="hljs-keyword">if</span>(! <span class="hljs-variable">$mtime</span>){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>; }

			<span class="hljs-variable">$iftime</span> = strtotime(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_IF_MODIFIED_SINCE'</span>]);
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"The conditional get's if-modified-since unixtime is $iftime"</span>);
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$iftime</span> &lt; <span class="hljs-number">1</span>){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Got an invalid conditional get modified since time. Returning false."</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			}
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$iftime</span> &lt; <span class="hljs-variable">$mtime</span>){ <span class="hljs-comment">//Real file or cache file has been modified since last request, so force refetch.</span>
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"File has been modified since last fetch."</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			} <span class="hljs-keyword">else</span> { <span class="hljs-comment">//Otherwise serve a 304</span>
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"File has not been modified since last get, so serving a 304."</span>);
				header (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_PROTOCOL'</span>] . <span class="hljs-string">' 304 Not Modified'</span>);
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Returning 304 not modified"</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
			}
		}
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tryServerCache</span><span class="hljs-params">()</span></span>{
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Trying server cache"</span>);
		<span class="hljs-keyword">if</span>(file_exists(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Cachefile {$this-&gt;cachefile} exists"</span>);
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;isURL</span>){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"This is an external request, so checking if the cachefile is empty which means the request failed previously."</span>);
				<span class="hljs-keyword">if</span>(filesize(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>) &lt; <span class="hljs-number">1</span>){
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Found an empty cachefile indicating a failed earlier request. Checking how old it is."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Fetching error occured previously</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>(time() - @filemtime(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>) &gt; WAIT_BETWEEN_FETCH_ERRORS){
						<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"File is older than "</span> . WAIT_BETWEEN_FETCH_ERRORS . <span class="hljs-string">" seconds. Deleting and returning false so app can try and load file."</span>);
						@unlink(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);
						<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>; <span class="hljs-comment">//to indicate we didn't serve from cache and app should try and load</span>
					} <span class="hljs-keyword">else</span> {
						<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Empty cachefile is still fresh so returning message saying we had an error fetching this image from remote host."</span>);
						<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;set404</span>();
						<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"An error occured fetching image."</span>);
						<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>; 
					}
				}
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Trying to serve cachefile {$this-&gt;cachefile}"</span>);
			}
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;serveCacheFile</span>()){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Succesfully served cachefile {$this-&gt;cachefile}"</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Failed to serve cachefile {$this-&gt;cachefile} - Deleting it from cache."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Image serving failed. We can’t retry at this point, but lets remove it from cache so the next request recreates it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				@unlink(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
			}
		}
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">error</span><span class="hljs-params">(<span class="hljs-variable">$err</span>)</span></span>{
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Adding error message: $err"</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;errors</span>[] = <span class="hljs-variable">$err</span>;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;

	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">haveErrors</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">if</span>(sizeof(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;errors</span>) &gt; <span class="hljs-number">0</span>){
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
		}
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveErrors</span><span class="hljs-params">()</span></span>{
		header (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_PROTOCOL'</span>] . <span class="hljs-string">' 400 Bad Request'</span>);
		<span class="hljs-keyword">if</span> ( ! DISPLAY_ERROR_MESSAGES ) {
			<span class="hljs-keyword">return</span>;
		}
		<span class="hljs-variable">$html</span> = <span class="hljs-string">'&lt;ul&gt;'</span>;
		<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;errors</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$err</span>){
			<span class="hljs-variable">$html</span> .= <span class="hljs-string">'&lt;li&gt;'</span> . htmlentities(<span class="hljs-variable">$err</span>) . <span class="hljs-string">'&lt;/li&gt;'</span>;
		}
		<span class="hljs-variable">$html</span> .= <span class="hljs-string">'&lt;/ul&gt;'</span>;
		<span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;h1&gt;A TimThumb error has occured&lt;/h1&gt;The following error(s) occured:&lt;br /&gt;'</span> . <span class="hljs-variable">$html</span> . <span class="hljs-string">'&lt;br /&gt;'</span>;
		<span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;br /&gt;Query String : '</span> . htmlentities( <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'QUERY_STRING'</span>], ENT_QUOTES );
		<span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;br /&gt;TimThumb version : '</span> . VERSION . <span class="hljs-string">'&lt;/pre&gt;'</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveInternalImage</span><span class="hljs-params">()</span></span>{
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Local image path is $this-&gt;localImage"</span>);
		<span class="hljs-keyword">if</span>(! <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;localImage</span>){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;sanityFail</span>(<span class="hljs-string">"localImage not set after verifying it earlier in the code."</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
		<span class="hljs-variable">$fileSize</span> = filesize(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;localImage</span>);
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$fileSize</span> &gt; MAX_FILE_SIZE){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"The file you specified is greater than the maximum allowed file size."</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$fileSize</span> &lt;= <span class="hljs-number">0</span>){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"The file you specified is &lt;= 0 bytes."</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Calling processImageAndWriteToCache() for local image."</span>);
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;processImageAndWriteToCache</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;localImage</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;serveCacheFile</span>();
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
		} <span class="hljs-keyword">else</span> { 
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanCache</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">if</span> (FILE_CACHE_TIME_BETWEEN_CLEANS &lt; <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">return</span>;
		}
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"cleanCache() called"</span>);
		<span class="hljs-variable">$lastCleanFile</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span> . <span class="hljs-string">'/timthumb_cacheLastCleanTime.touch'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>If this is a new timthumb installation we need to create the file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(! is_file(<span class="hljs-variable">$lastCleanFile</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"File tracking last clean doesn't exist. Creating $lastCleanFile"</span>);
			<span class="hljs-keyword">if</span> (!touch(<span class="hljs-variable">$lastCleanFile</span>)) {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not create cache clean timestamp file."</span>);
			}
			<span class="hljs-keyword">return</span>;
		}
		<span class="hljs-keyword">if</span>(@filemtime(<span class="hljs-variable">$lastCleanFile</span>) &lt; (time() - FILE_CACHE_TIME_BETWEEN_CLEANS) ){ <span class="hljs-comment">//Cache was last cleaned more than 1 day ago</span>
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Cache was last cleaned more than "</span> . FILE_CACHE_TIME_BETWEEN_CLEANS . <span class="hljs-string">" seconds ago. Cleaning now."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Very slight race condition here, but worst case we’ll have 2 or 3 servers cleaning the cache simultaneously once a day.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (!touch(<span class="hljs-variable">$lastCleanFile</span>)) {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not create cache clean timestamp file."</span>);
			}
			<span class="hljs-variable">$files</span> = glob(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span> . <span class="hljs-string">'/*'</span> . FILE_CACHE_SUFFIX);
			<span class="hljs-keyword">if</span> (<span class="hljs-variable">$files</span>) {
				<span class="hljs-variable">$timeAgo</span> = time() - FILE_CACHE_MAX_FILE_AGE;
				<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$files</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$file</span>){
					<span class="hljs-keyword">if</span>(@filemtime(<span class="hljs-variable">$file</span>) &lt; <span class="hljs-variable">$timeAgo</span>){
						<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Deleting cache file $file older than max age: "</span> . FILE_CACHE_MAX_FILE_AGE . <span class="hljs-string">" seconds"</span>);
						@unlink(<span class="hljs-variable">$file</span>);
					}
				}
			}
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Cache was cleaned less than "</span> . FILE_CACHE_TIME_BETWEEN_CLEANS . <span class="hljs-string">" seconds ago so no cleaning needed."</span>);
		}
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processImageAndWriteToCache</span><span class="hljs-params">(<span class="hljs-variable">$localImage</span>)</span></span>{
		<span class="hljs-variable">$sData</span> = getimagesize(<span class="hljs-variable">$localImage</span>);
		<span class="hljs-variable">$origType</span> = <span class="hljs-variable">$sData</span>[<span class="hljs-number">2</span>];
		<span class="hljs-variable">$mimeType</span> = <span class="hljs-variable">$sData</span>[<span class="hljs-string">'mime'</span>];

		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Mime type of image is $mimeType"</span>);
		<span class="hljs-keyword">if</span>(! preg_match(<span class="hljs-string">'/^image\/(?:gif|jpg|jpeg|png)$/i'</span>, <span class="hljs-variable">$mimeType</span>)){
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"The image being resized is not a valid gif, jpg or png."</span>);
		}

		<span class="hljs-keyword">if</span> (!function_exists (<span class="hljs-string">'imagecreatetruecolor'</span>)) {
		    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">'GD Library Error: imagecreatetruecolor does not exist - please contact your webhost and ask them to install the GD library'</span>);
		}

		<span class="hljs-keyword">if</span> (function_exists (<span class="hljs-string">'imagefilter'</span>) &amp;&amp; defined (<span class="hljs-string">'IMG_FILTER_NEGATE'</span>)) {
			<span class="hljs-variable">$imageFilters</span> = <span class="hljs-keyword">array</span> (
				<span class="hljs-number">1</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_NEGATE, <span class="hljs-number">0</span>),
				<span class="hljs-number">2</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_GRAYSCALE, <span class="hljs-number">0</span>),
				<span class="hljs-number">3</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_BRIGHTNESS, <span class="hljs-number">1</span>),
				<span class="hljs-number">4</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_CONTRAST, <span class="hljs-number">1</span>),
				<span class="hljs-number">5</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_COLORIZE, <span class="hljs-number">4</span>),
				<span class="hljs-number">6</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_EDGEDETECT, <span class="hljs-number">0</span>),
				<span class="hljs-number">7</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_EMBOSS, <span class="hljs-number">0</span>),
				<span class="hljs-number">8</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_GAUSSIAN_BLUR, <span class="hljs-number">0</span>),
				<span class="hljs-number">9</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_SELECTIVE_BLUR, <span class="hljs-number">0</span>),
				<span class="hljs-number">10</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_MEAN_REMOVAL, <span class="hljs-number">0</span>),
				<span class="hljs-number">11</span> =&gt; <span class="hljs-keyword">array</span> (IMG_FILTER_SMOOTH, <span class="hljs-number">0</span>),
			);
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>get standard input properties        </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-variable">$new_width</span> =  (int) abs (<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'w'</span>, <span class="hljs-number">0</span>));
		<span class="hljs-variable">$new_height</span> = (int) abs (<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'h'</span>, <span class="hljs-number">0</span>));
		<span class="hljs-variable">$zoom_crop</span> = (int) <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'zc'</span>, DEFAULT_ZC);
		<span class="hljs-variable">$quality</span> = (int) abs (<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'q'</span>, DEFAULT_Q));
		<span class="hljs-variable">$align</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cropTop</span> ? <span class="hljs-string">'t'</span> : <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>);
		<span class="hljs-variable">$filters</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'f'</span>, DEFAULT_F);
		<span class="hljs-variable">$sharpen</span> = (bool) <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'s'</span>, DEFAULT_S);
		<span class="hljs-variable">$canvas_color</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'cc'</span>, DEFAULT_CC);
		<span class="hljs-variable">$canvas_trans</span> = (bool) <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;param</span>(<span class="hljs-string">'ct'</span>, <span class="hljs-string">'1'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>set default width and height if neither are set already</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$new_width</span> == <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$new_height</span> == <span class="hljs-number">0</span>) {
		    <span class="hljs-variable">$new_width</span> = (int) DEFAULT_WIDTH;
		    <span class="hljs-variable">$new_height</span> = (int) DEFAULT_HEIGHT;
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>ensure size limits can not be abused</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-variable">$new_width</span> = min (<span class="hljs-variable">$new_width</span>, MAX_WIDTH);
		<span class="hljs-variable">$new_height</span> = min (<span class="hljs-variable">$new_height</span>, MAX_HEIGHT);</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>set memory limit to be able to have enough space to resize larger images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;setMemoryLimit</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>open the existing image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-variable">$image</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;openImage</span> (<span class="hljs-variable">$mimeType</span>, <span class="hljs-variable">$localImage</span>);
		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$image</span> === <span class="hljs-keyword">false</span>) {
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">'Unable to open image.'</span>);
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Get original width and height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-variable">$width</span> = imagesx (<span class="hljs-variable">$image</span>);
		<span class="hljs-variable">$height</span> = imagesy (<span class="hljs-variable">$image</span>);
		<span class="hljs-variable">$origin_x</span> = <span class="hljs-number">0</span>;
		<span class="hljs-variable">$origin_y</span> = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>generate new w/h if not provided</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$new_width</span> &amp;&amp; !<span class="hljs-variable">$new_height</span>) {
			<span class="hljs-variable">$new_height</span> = floor (<span class="hljs-variable">$height</span> * (<span class="hljs-variable">$new_width</span> / <span class="hljs-variable">$width</span>));
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">$new_height</span> &amp;&amp; !<span class="hljs-variable">$new_width</span>) {
			<span class="hljs-variable">$new_width</span> = floor (<span class="hljs-variable">$width</span> * (<span class="hljs-variable">$new_height</span> / <span class="hljs-variable">$height</span>));
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>scale down and add borders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$zoom_crop</span> == <span class="hljs-number">3</span>) {

			<span class="hljs-variable">$final_height</span> = <span class="hljs-variable">$height</span> * (<span class="hljs-variable">$new_width</span> / <span class="hljs-variable">$width</span>);

			<span class="hljs-keyword">if</span> (<span class="hljs-variable">$final_height</span> &gt; <span class="hljs-variable">$new_height</span>) {
				<span class="hljs-variable">$new_width</span> = <span class="hljs-variable">$width</span> * (<span class="hljs-variable">$new_height</span> / <span class="hljs-variable">$height</span>);
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-variable">$new_height</span> = <span class="hljs-variable">$final_height</span>;
			}

		}</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>create a new true color image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-variable">$canvas</span> = imagecreatetruecolor (<span class="hljs-variable">$new_width</span>, <span class="hljs-variable">$new_height</span>);
		imagealphablending (<span class="hljs-variable">$canvas</span>, <span class="hljs-keyword">false</span>);

		<span class="hljs-keyword">if</span> (strlen(<span class="hljs-variable">$canvas_color</span>) == <span class="hljs-number">3</span>) { <span class="hljs-comment">//if is 3-char notation, edit string into 6-char notation</span>
			<span class="hljs-variable">$canvas_color</span> =  str_repeat(substr(<span class="hljs-variable">$canvas_color</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>), <span class="hljs-number">2</span>) . str_repeat(substr(<span class="hljs-variable">$canvas_color</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), <span class="hljs-number">2</span>) . str_repeat(substr(<span class="hljs-variable">$canvas_color</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>), <span class="hljs-number">2</span>); 
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strlen(<span class="hljs-variable">$canvas_color</span>) != <span class="hljs-number">6</span>) {
			<span class="hljs-variable">$canvas_color</span> = DEFAULT_CC; <span class="hljs-comment">// on error return default canvas color</span>
 		}

		<span class="hljs-variable">$canvas_color_R</span> = hexdec (substr (<span class="hljs-variable">$canvas_color</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>));
		<span class="hljs-variable">$canvas_color_G</span> = hexdec (substr (<span class="hljs-variable">$canvas_color</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>));
		<span class="hljs-variable">$canvas_color_B</span> = hexdec (substr (<span class="hljs-variable">$canvas_color</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Create a new transparent color for image
If is a png and PNG_IS_TRANSPARENT is false then remove the alpha transparency 
(and if is set a canvas color show it in the background)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/^image\/png$/i'</span>, <span class="hljs-variable">$mimeType</span>) &amp;&amp; !PNG_IS_TRANSPARENT &amp;&amp; <span class="hljs-variable">$canvas_trans</span>){ 
			<span class="hljs-variable">$color</span> = imagecolorallocatealpha (<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$canvas_color_R</span>, <span class="hljs-variable">$canvas_color_G</span>, <span class="hljs-variable">$canvas_color_B</span>, <span class="hljs-number">127</span>);		
		}<span class="hljs-keyword">else</span>{
			<span class="hljs-variable">$color</span> = imagecolorallocatealpha (<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$canvas_color_R</span>, <span class="hljs-variable">$canvas_color_G</span>, <span class="hljs-variable">$canvas_color_B</span>, <span class="hljs-number">0</span>);
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Completely fill the background of the new image with allocated color.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		imagefill (<span class="hljs-variable">$canvas</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$color</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>scale down and add borders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$zoom_crop</span> == <span class="hljs-number">2</span>) {

			<span class="hljs-variable">$final_height</span> = <span class="hljs-variable">$height</span> * (<span class="hljs-variable">$new_width</span> / <span class="hljs-variable">$width</span>);

			<span class="hljs-keyword">if</span> (<span class="hljs-variable">$final_height</span> &gt; <span class="hljs-variable">$new_height</span>) {

				<span class="hljs-variable">$origin_x</span> = <span class="hljs-variable">$new_width</span> / <span class="hljs-number">2</span>;
				<span class="hljs-variable">$new_width</span> = <span class="hljs-variable">$width</span> * (<span class="hljs-variable">$new_height</span> / <span class="hljs-variable">$height</span>);
				<span class="hljs-variable">$origin_x</span> = round (<span class="hljs-variable">$origin_x</span> - (<span class="hljs-variable">$new_width</span> / <span class="hljs-number">2</span>));

			} <span class="hljs-keyword">else</span> {

				<span class="hljs-variable">$origin_y</span> = <span class="hljs-variable">$new_height</span> / <span class="hljs-number">2</span>;
				<span class="hljs-variable">$new_height</span> = <span class="hljs-variable">$final_height</span>;
				<span class="hljs-variable">$origin_y</span> = round (<span class="hljs-variable">$origin_y</span> - (<span class="hljs-variable">$new_height</span> / <span class="hljs-number">2</span>));

			}

		}</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Restore transparency blending</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		imagesavealpha (<span class="hljs-variable">$canvas</span>, <span class="hljs-keyword">true</span>);

		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$zoom_crop</span> &gt; <span class="hljs-number">0</span>) {

			<span class="hljs-variable">$src_x</span> = <span class="hljs-variable">$src_y</span> = <span class="hljs-number">0</span>;
			<span class="hljs-variable">$src_w</span> = <span class="hljs-variable">$width</span>;
			<span class="hljs-variable">$src_h</span> = <span class="hljs-variable">$height</span>;

			<span class="hljs-variable">$cmp_x</span> = <span class="hljs-variable">$width</span> / <span class="hljs-variable">$new_width</span>;
			<span class="hljs-variable">$cmp_y</span> = <span class="hljs-variable">$height</span> / <span class="hljs-variable">$new_height</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>calculate x or y coordinate and width or height of source</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (<span class="hljs-variable">$cmp_x</span> &gt; <span class="hljs-variable">$cmp_y</span>) {

				<span class="hljs-variable">$src_w</span> = round (<span class="hljs-variable">$width</span> / <span class="hljs-variable">$cmp_x</span> * <span class="hljs-variable">$cmp_y</span>);
				<span class="hljs-variable">$src_x</span> = round ((<span class="hljs-variable">$width</span> - (<span class="hljs-variable">$width</span> / <span class="hljs-variable">$cmp_x</span> * <span class="hljs-variable">$cmp_y</span>)) / <span class="hljs-number">2</span>);

			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">$cmp_y</span> &gt; <span class="hljs-variable">$cmp_x</span>) {

				<span class="hljs-variable">$src_h</span> = round (<span class="hljs-variable">$height</span> / <span class="hljs-variable">$cmp_y</span> * <span class="hljs-variable">$cmp_x</span>);
				<span class="hljs-variable">$src_y</span> = round ((<span class="hljs-variable">$height</span> - (<span class="hljs-variable">$height</span> / <span class="hljs-variable">$cmp_y</span> * <span class="hljs-variable">$cmp_x</span>)) / <span class="hljs-number">2</span>);

			}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>positional cropping!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (<span class="hljs-variable">$align</span>) {
				<span class="hljs-keyword">if</span> (strpos (<span class="hljs-variable">$align</span>, <span class="hljs-string">'t'</span>) !== <span class="hljs-keyword">false</span>) {
					<span class="hljs-variable">$src_y</span> = <span class="hljs-number">0</span>;
				}
				<span class="hljs-keyword">if</span> (strpos (<span class="hljs-variable">$align</span>, <span class="hljs-string">'b'</span>) !== <span class="hljs-keyword">false</span>) {
					<span class="hljs-variable">$src_y</span> = <span class="hljs-variable">$height</span> - <span class="hljs-variable">$src_h</span>;
				}
				<span class="hljs-keyword">if</span> (strpos (<span class="hljs-variable">$align</span>, <span class="hljs-string">'l'</span>) !== <span class="hljs-keyword">false</span>) {
					<span class="hljs-variable">$src_x</span> = <span class="hljs-number">0</span>;
				}
				<span class="hljs-keyword">if</span> (strpos (<span class="hljs-variable">$align</span>, <span class="hljs-string">'r'</span>) !== <span class="hljs-keyword">false</span>) {
					<span class="hljs-variable">$src_x</span> = <span class="hljs-variable">$width</span> - <span class="hljs-variable">$src_w</span>;
				}
			}

			imagecopyresampled (<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$image</span>, <span class="hljs-variable">$origin_x</span>, <span class="hljs-variable">$origin_y</span>, <span class="hljs-variable">$src_x</span>, <span class="hljs-variable">$src_y</span>, <span class="hljs-variable">$new_width</span>, <span class="hljs-variable">$new_height</span>, <span class="hljs-variable">$src_w</span>, <span class="hljs-variable">$src_h</span>);

		} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>copy and resize part of an image with resampling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			imagecopyresampled (<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$image</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$new_width</span>, <span class="hljs-variable">$new_height</span>, <span class="hljs-variable">$width</span>, <span class="hljs-variable">$height</span>);

		}

		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$filters</span> != <span class="hljs-string">''</span> &amp;&amp; function_exists (<span class="hljs-string">'imagefilter'</span>) &amp;&amp; defined (<span class="hljs-string">'IMG_FILTER_NEGATE'</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>apply filters to image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-variable">$filterList</span> = explode (<span class="hljs-string">'|'</span>, <span class="hljs-variable">$filters</span>);
			<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filterList</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$fl</span>) {

				<span class="hljs-variable">$filterSettings</span> = explode (<span class="hljs-string">','</span>, <span class="hljs-variable">$fl</span>);
				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$imageFilters</span>[<span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">0</span>]])) {

					<span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">4</span>; <span class="hljs-variable">$i</span> ++) {
						<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$filterSettings</span>[<span class="hljs-variable">$i</span>])) {
							<span class="hljs-variable">$filterSettings</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-keyword">null</span>;
						} <span class="hljs-keyword">else</span> {
							<span class="hljs-variable">$filterSettings</span>[<span class="hljs-variable">$i</span>] = (int) <span class="hljs-variable">$filterSettings</span>[<span class="hljs-variable">$i</span>];
						}
					}

					<span class="hljs-keyword">switch</span> (<span class="hljs-variable">$imageFilters</span>[<span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">0</span>]][<span class="hljs-number">1</span>]) {

						<span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:

							imagefilter (<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$imageFilters</span>[<span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">0</span>]][<span class="hljs-number">0</span>], <span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">1</span>]);
							<span class="hljs-keyword">break</span>;

						<span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:

							imagefilter (<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$imageFilters</span>[<span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">0</span>]][<span class="hljs-number">0</span>], <span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">1</span>], <span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">2</span>]);
							<span class="hljs-keyword">break</span>;

						<span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:

							imagefilter (<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$imageFilters</span>[<span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">0</span>]][<span class="hljs-number">0</span>], <span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">1</span>], <span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">2</span>], <span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">3</span>]);
							<span class="hljs-keyword">break</span>;

						<span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:

							imagefilter (<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$imageFilters</span>[<span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">0</span>]][<span class="hljs-number">0</span>], <span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">1</span>], <span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">2</span>], <span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">3</span>], <span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">4</span>]);
							<span class="hljs-keyword">break</span>;

						<span class="hljs-keyword">default</span>:

							imagefilter (<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$imageFilters</span>[<span class="hljs-variable">$filterSettings</span>[<span class="hljs-number">0</span>]][<span class="hljs-number">0</span>]);
							<span class="hljs-keyword">break</span>;

					}
				}
			}
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>sharpen image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$sharpen</span> &amp;&amp; function_exists (<span class="hljs-string">'imageconvolution'</span>)) {

			<span class="hljs-variable">$sharpenMatrix</span> = <span class="hljs-keyword">array</span> (
					<span class="hljs-keyword">array</span> (-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>),
					<span class="hljs-keyword">array</span> (-<span class="hljs-number">1</span>,<span class="hljs-number">16</span>,-<span class="hljs-number">1</span>),
					<span class="hljs-keyword">array</span> (-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>),
					);

			<span class="hljs-variable">$divisor</span> = <span class="hljs-number">8</span>;
			<span class="hljs-variable">$offset</span> = <span class="hljs-number">0</span>;

			imageconvolution (<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$sharpenMatrix</span>, <span class="hljs-variable">$divisor</span>, <span class="hljs-variable">$offset</span>);

		}</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Straight from Wordpress core code. Reduces filesize by up to 70% for PNG’s</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> ( (IMAGETYPE_PNG == <span class="hljs-variable">$origType</span> || IMAGETYPE_GIF == <span class="hljs-variable">$origType</span>) &amp;&amp; function_exists(<span class="hljs-string">'imageistruecolor'</span>) &amp;&amp; !imageistruecolor( <span class="hljs-variable">$image</span> ) &amp;&amp; imagecolortransparent( <span class="hljs-variable">$image</span> ) &gt; <span class="hljs-number">0</span> ){
			imagetruecolortopalette( <span class="hljs-variable">$canvas</span>, <span class="hljs-keyword">false</span>, imagecolorstotal( <span class="hljs-variable">$image</span> ) );
		}

		<span class="hljs-variable">$imgType</span> = <span class="hljs-string">""</span>;
		<span class="hljs-variable">$tempfile</span> = tempnam(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span>, <span class="hljs-string">'timthumb_tmpimg_'</span>);
		<span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/^image\/(?:jpg|jpeg)$/i'</span>, <span class="hljs-variable">$mimeType</span>)){ 
			<span class="hljs-variable">$imgType</span> = <span class="hljs-string">'jpg'</span>;
			imagejpeg(<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$tempfile</span>, <span class="hljs-variable">$quality</span>); 
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/^image\/png$/i'</span>, <span class="hljs-variable">$mimeType</span>)){ 
			<span class="hljs-variable">$imgType</span> = <span class="hljs-string">'png'</span>;
			imagepng(<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$tempfile</span>, floor(<span class="hljs-variable">$quality</span> * <span class="hljs-number">0.09</span>));
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/^image\/gif$/i'</span>, <span class="hljs-variable">$mimeType</span>)){
			<span class="hljs-variable">$imgType</span> = <span class="hljs-string">'gif'</span>;
			imagegif(<span class="hljs-variable">$canvas</span>, <span class="hljs-variable">$tempfile</span>);
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;sanityFail</span>(<span class="hljs-string">"Could not match mime type after verifying it previously."</span>);
		}

		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$imgType</span> == <span class="hljs-string">'png'</span> &amp;&amp; OPTIPNG_ENABLED &amp;&amp; OPTIPNG_PATH &amp;&amp; @is_file(OPTIPNG_PATH)){
			<span class="hljs-variable">$exec</span> = OPTIPNG_PATH;
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"optipng'ing $tempfile"</span>);
			<span class="hljs-variable">$presize</span> = filesize(<span class="hljs-variable">$tempfile</span>);
			<span class="hljs-variable">$out</span> = `<span class="hljs-variable">$exec</span> -o1 <span class="hljs-variable">$tempfile</span>`; <span class="hljs-comment">//you can use up to -o7 but it really slows things down</span>
			clearstatcache();
			<span class="hljs-variable">$aftersize</span> = filesize(<span class="hljs-variable">$tempfile</span>);
			<span class="hljs-variable">$sizeDrop</span> = <span class="hljs-variable">$presize</span> - <span class="hljs-variable">$aftersize</span>;
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$sizeDrop</span> &gt; <span class="hljs-number">0</span>){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"optipng reduced size by $sizeDrop"</span>);
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$sizeDrop</span> &lt; <span class="hljs-number">0</span>){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"optipng increased size! Difference was: $sizeDrop"</span>);
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"optipng did not change image size."</span>);
			}
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$imgType</span> == <span class="hljs-string">'png'</span> &amp;&amp; PNGCRUSH_ENABLED &amp;&amp; PNGCRUSH_PATH &amp;&amp; @is_file(PNGCRUSH_PATH)){
			<span class="hljs-variable">$exec</span> = PNGCRUSH_PATH;
			<span class="hljs-variable">$tempfile2</span> = tempnam(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span>, <span class="hljs-string">'timthumb_tmpimg_'</span>);
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"pngcrush'ing $tempfile to $tempfile2"</span>);
			<span class="hljs-variable">$out</span> = `<span class="hljs-variable">$exec</span> <span class="hljs-variable">$tempfile</span> <span class="hljs-variable">$tempfile2</span>`;
			<span class="hljs-variable">$todel</span> = <span class="hljs-string">""</span>;
			<span class="hljs-keyword">if</span>(is_file(<span class="hljs-variable">$tempfile2</span>)){
				<span class="hljs-variable">$sizeDrop</span> = filesize(<span class="hljs-variable">$tempfile</span>) - filesize(<span class="hljs-variable">$tempfile2</span>);
				<span class="hljs-keyword">if</span>(<span class="hljs-variable">$sizeDrop</span> &gt; <span class="hljs-number">0</span>){
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"pngcrush was succesful and gave a $sizeDrop byte size reduction"</span>);
					<span class="hljs-variable">$todel</span> = <span class="hljs-variable">$tempfile</span>;
					<span class="hljs-variable">$tempfile</span> = <span class="hljs-variable">$tempfile2</span>;
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"pngcrush did not reduce file size. Difference was $sizeDrop bytes."</span>);
					<span class="hljs-variable">$todel</span> = <span class="hljs-variable">$tempfile2</span>;
				}
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"pngcrush failed with output: $out"</span>);
				<span class="hljs-variable">$todel</span> = <span class="hljs-variable">$tempfile2</span>;
			}
			@unlink(<span class="hljs-variable">$todel</span>);
		}

		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Rewriting image with security header."</span>);
		<span class="hljs-variable">$tempfile4</span> = tempnam(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span>, <span class="hljs-string">'timthumb_tmpimg_'</span>);
		<span class="hljs-variable">$context</span> = stream_context_create ();
		<span class="hljs-variable">$fp</span> = fopen(<span class="hljs-variable">$tempfile</span>,<span class="hljs-string">'r'</span>,<span class="hljs-number">0</span>,<span class="hljs-variable">$context</span>);
		file_put_contents(<span class="hljs-variable">$tempfile4</span>, <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;filePrependSecurityBlock</span> . <span class="hljs-variable">$imgType</span> . <span class="hljs-string">' ?'</span> . <span class="hljs-string">'&gt;'</span>); <span class="hljs-comment">//6 extra bytes, first 3 being image type </span>
		file_put_contents(<span class="hljs-variable">$tempfile4</span>, <span class="hljs-variable">$fp</span>, FILE_APPEND);
		fclose(<span class="hljs-variable">$fp</span>);
		@unlink(<span class="hljs-variable">$tempfile</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Locking and replacing cache file."</span>);
		<span class="hljs-variable">$lockFile</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span> . <span class="hljs-string">'.lock'</span>;
		<span class="hljs-variable">$fh</span> = fopen(<span class="hljs-variable">$lockFile</span>, <span class="hljs-string">'w'</span>);
		<span class="hljs-keyword">if</span>(! <span class="hljs-variable">$fh</span>){
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not open the lockfile for writing an image."</span>);
		}
		<span class="hljs-keyword">if</span>(flock(<span class="hljs-variable">$fh</span>, LOCK_EX)){
			@unlink(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>); <span class="hljs-comment">//rename generally overwrites, but doing this in case of platform specific quirks. File might not exist yet.</span>
			rename(<span class="hljs-variable">$tempfile4</span>, <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);
			flock(<span class="hljs-variable">$fh</span>, LOCK_UN);
			fclose(<span class="hljs-variable">$fh</span>);
			@unlink(<span class="hljs-variable">$lockFile</span>);
		} <span class="hljs-keyword">else</span> {
			fclose(<span class="hljs-variable">$fh</span>);
			@unlink(<span class="hljs-variable">$lockFile</span>);
			@unlink(<span class="hljs-variable">$tempfile4</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not get a lock for writing."</span>);
		}
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Done image replace with security header. Cleaning up and running cleanCache()"</span>);
		imagedestroy(<span class="hljs-variable">$canvas</span>);
		imagedestroy(<span class="hljs-variable">$image</span>);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calcDocRoot</span><span class="hljs-params">()</span></span>{
		<span class="hljs-variable">$docRoot</span> = @<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'DOCUMENT_ROOT'</span>];
		<span class="hljs-keyword">if</span> (defined(<span class="hljs-string">'LOCAL_FILE_BASE_DIRECTORY'</span>)) {
			<span class="hljs-variable">$docRoot</span> = LOCAL_FILE_BASE_DIRECTORY;   
		}
		<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$docRoot</span>)){ 
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"DOCUMENT_ROOT is not set. This is probably windows. Starting search 1."</span>);
			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SCRIPT_FILENAME'</span>])){
				<span class="hljs-variable">$docRoot</span> = str_replace( <span class="hljs-string">'\\'</span>, <span class="hljs-string">'/'</span>, substr(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SCRIPT_FILENAME'</span>], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>-strlen(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'PHP_SELF'</span>])));
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Generated docRoot using SCRIPT_FILENAME and PHP_SELF as: $docRoot"</span>);
			} 
		}
		<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$docRoot</span>)){ 
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"DOCUMENT_ROOT still is not set. Starting search 2."</span>);
			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'PATH_TRANSLATED'</span>])){
				<span class="hljs-variable">$docRoot</span> = str_replace( <span class="hljs-string">'\\'</span>, <span class="hljs-string">'/'</span>, substr(str_replace(<span class="hljs-string">'\\\\'</span>, <span class="hljs-string">'\\'</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'PATH_TRANSLATED'</span>]), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>-strlen(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'PHP_SELF'</span>])));
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Generated docRoot using PATH_TRANSLATED and PHP_SELF as: $docRoot"</span>);
			} 
		}
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$docRoot</span> &amp;&amp; <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'DOCUMENT_ROOT'</span>] != <span class="hljs-string">'/'</span>){ <span class="hljs-variable">$docRoot</span> = preg_replace(<span class="hljs-string">'/\/$/'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$docRoot</span>); }
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Doc root is: "</span> . <span class="hljs-variable">$docRoot</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span> = <span class="hljs-variable">$docRoot</span>;

	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLocalImagePath</span><span class="hljs-params">(<span class="hljs-variable">$src</span>)</span></span>{
		<span class="hljs-variable">$src</span> = ltrim(<span class="hljs-variable">$src</span>, <span class="hljs-string">'/'</span>); <span class="hljs-comment">//strip off the leading '/'</span>
		<span class="hljs-keyword">if</span>(! <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span>){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"We have no document root set, so as a last resort, lets check if the image is in the current dir and serve that."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>We don’t support serving images outside the current dir if we don’t have a doc root for security reasons.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-variable">$file</span> = preg_replace(<span class="hljs-string">'/^.*?([^\/\\\\]+)$/'</span>, <span class="hljs-string">'$1'</span>, <span class="hljs-variable">$src</span>); <span class="hljs-comment">//strip off any path info and just leave the filename.</span>
			<span class="hljs-keyword">if</span>(is_file(<span class="hljs-variable">$file</span>)){
				<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;realpath</span>(<span class="hljs-variable">$file</span>);
			}
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not find your website document root and the file specified doesn't exist in timthumbs directory. We don't support serving files outside timthumb's directory without a document root for security reasons."</span>);
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( ! is_dir( <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span> ) ) {
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Server path does not exist. Ensure variable \$_SERVER['DOCUMENT_ROOT'] is set correctly"</span>);
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Do not go past this point without docRoot set</p>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Try src under docRoot</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(file_exists (<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span> . <span class="hljs-string">'/'</span> . <span class="hljs-variable">$src</span>)) {
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Found file as "</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span> . <span class="hljs-string">'/'</span> . <span class="hljs-variable">$src</span>);
			<span class="hljs-variable">$real</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;realpath</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span> . <span class="hljs-string">'/'</span> . <span class="hljs-variable">$src</span>);
			<span class="hljs-keyword">if</span>(stripos(<span class="hljs-variable">$real</span>, <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span>) === <span class="hljs-number">0</span>){
				<span class="hljs-keyword">return</span> <span class="hljs-variable">$real</span>;
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Security block: The file specified occurs outside the document root."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>allow search to continue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			}
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Check absolute paths and then verify the real path is under doc root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-variable">$absolute</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;realpath</span>(<span class="hljs-string">'/'</span> . <span class="hljs-variable">$src</span>);
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$absolute</span> &amp;&amp; file_exists(<span class="hljs-variable">$absolute</span>)){ <span class="hljs-comment">//realpath does file_exists check, so can probably skip the exists check here</span>
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Found absolute path: $absolute"</span>);
			<span class="hljs-keyword">if</span>(! <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span>){ <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;sanityFail</span>(<span class="hljs-string">"docRoot not set when checking absolute path."</span>); }
			<span class="hljs-keyword">if</span>(stripos(<span class="hljs-variable">$absolute</span>, <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span>) === <span class="hljs-number">0</span>){
				<span class="hljs-keyword">return</span> <span class="hljs-variable">$absolute</span>;
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Security block: The file specified occurs outside the document root."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>and continue search</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			}
		}
		
		<span class="hljs-variable">$base</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>account for Windows directory structure</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (strstr(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SCRIPT_FILENAME'</span>],<span class="hljs-string">':'</span>)) {
			<span class="hljs-variable">$sub_directories</span> = explode(<span class="hljs-string">'\\'</span>, str_replace(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SCRIPT_FILENAME'</span>]));
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$sub_directories</span> = explode(<span class="hljs-string">'/'</span>, str_replace(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SCRIPT_FILENAME'</span>]));
		}

		<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$sub_directories</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$sub</span>){
			<span class="hljs-variable">$base</span> .= <span class="hljs-variable">$sub</span> . <span class="hljs-string">'/'</span>;
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Trying file as: "</span> . <span class="hljs-variable">$base</span> . <span class="hljs-variable">$src</span>);
			<span class="hljs-keyword">if</span>(file_exists(<span class="hljs-variable">$base</span> . <span class="hljs-variable">$src</span>)){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Found file as: "</span> . <span class="hljs-variable">$base</span> . <span class="hljs-variable">$src</span>);
				<span class="hljs-variable">$real</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;realpath</span>(<span class="hljs-variable">$base</span> . <span class="hljs-variable">$src</span>);
				<span class="hljs-keyword">if</span>(stripos(<span class="hljs-variable">$real</span>, <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;realpath</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;docRoot</span>)) === <span class="hljs-number">0</span>){
					<span class="hljs-keyword">return</span> <span class="hljs-variable">$real</span>;
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Security block: The file specified occurs outside the document root."</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>And continue search</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				}
			}
		}
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">realpath</span><span class="hljs-params">(<span class="hljs-variable">$path</span>)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>try to remove any relative paths</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-variable">$remove_relatives</span> = <span class="hljs-string">'/\w+\/\.\.\//'</span>;
		<span class="hljs-keyword">while</span>(preg_match(<span class="hljs-variable">$remove_relatives</span>,<span class="hljs-variable">$path</span>)){
		    <span class="hljs-variable">$path</span> = preg_replace(<span class="hljs-variable">$remove_relatives</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$path</span>);
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>if any remain use PHP realpath to strip them out, otherwise return $path
if using realpath, any symlinks will also be resolved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> preg_match(<span class="hljs-string">'#^\.\./|/\.\./#'</span>, <span class="hljs-variable">$path</span>) ? realpath(<span class="hljs-variable">$path</span>) : <span class="hljs-variable">$path</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toDelete</span><span class="hljs-params">(<span class="hljs-variable">$name</span>)</span></span>{
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Scheduling file $name to delete on destruct."</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;toDeletes</span>[] = <span class="hljs-variable">$name</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveWebshot</span><span class="hljs-params">()</span></span>{
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Starting serveWebshot"</span>);
		<span class="hljs-variable">$instr</span> = <span class="hljs-string">"Please follow the instructions at http://code.google.com/p/timthumb/ to set your server up for taking website screenshots."</span>;
		<span class="hljs-keyword">if</span>(! is_file(WEBSHOT_CUTYCAPT)){
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"CutyCapt is not installed. $instr"</span>);
		}
		<span class="hljs-keyword">if</span>(! is_file(WEBSHOT_XVFB)){
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;Error</span>(<span class="hljs-string">"Xvfb is not installed. $instr"</span>);
		}
		<span class="hljs-variable">$cuty</span> = WEBSHOT_CUTYCAPT;
		<span class="hljs-variable">$xv</span> = WEBSHOT_XVFB;
		<span class="hljs-variable">$screenX</span> = WEBSHOT_SCREEN_X;
		<span class="hljs-variable">$screenY</span> = WEBSHOT_SCREEN_Y;
		<span class="hljs-variable">$colDepth</span> = WEBSHOT_COLOR_DEPTH;
		<span class="hljs-variable">$format</span> = WEBSHOT_IMAGE_FORMAT;
		<span class="hljs-variable">$timeout</span> = WEBSHOT_TIMEOUT * <span class="hljs-number">1000</span>;
		<span class="hljs-variable">$ua</span> = WEBSHOT_USER_AGENT;
		<span class="hljs-variable">$jsOn</span> = WEBSHOT_JAVASCRIPT_ON ? <span class="hljs-string">'on'</span> : <span class="hljs-string">'off'</span>;
		<span class="hljs-variable">$javaOn</span> = WEBSHOT_JAVA_ON ? <span class="hljs-string">'on'</span> : <span class="hljs-string">'off'</span>;
		<span class="hljs-variable">$pluginsOn</span> = WEBSHOT_PLUGINS_ON ? <span class="hljs-string">'on'</span> : <span class="hljs-string">'off'</span>;
		<span class="hljs-variable">$proxy</span> = WEBSHOT_PROXY ? <span class="hljs-string">' --http-proxy='</span> . WEBSHOT_PROXY : <span class="hljs-string">''</span>;
		<span class="hljs-variable">$tempfile</span> = tempnam(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span>, <span class="hljs-string">'timthumb_webshot'</span>);
		<span class="hljs-variable">$url</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span>;
		<span class="hljs-keyword">if</span>(! preg_match(<span class="hljs-string">'/^https?:\/\/[a-zA-Z0-9\.\-]+/i'</span>, <span class="hljs-variable">$url</span>)){
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Invalid URL supplied."</span>);
		}
		<span class="hljs-variable">$url</span> = preg_replace(<span class="hljs-string">'/[^A-Za-z0-9\-\.\_:\/\?\&amp;\+\;\=]+/'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$url</span>); <span class="hljs-comment">//RFC 3986 plus ()$ chars to prevent exploit below. Plus the following are also removed: @*!~#[]',</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>2014 update by Mark Maunder: This exploit: <a href="http://cxsecurity.com/issue/WLB-2014060134">http://cxsecurity.com/issue/WLB-2014060134</a>
uses the $(command) shell execution syntax to execute arbitrary shell commands as the web server user. 
So we’re now filtering out the characters: ‘$’, ‘(‘ and ‘)’ in the above regex to avoid this. 
We are also filtering out chars rarely used in URLs but legal accoring to the URL RFC which might be exploitable. These include: @*!~#[]’,
We’re doing this because we’re passing this URL to the shell and need to make very sure it’s not going to execute arbitrary commands. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(WEBSHOT_XVFB_RUNNING){
			putenv(<span class="hljs-string">'DISPLAY=:100.0'</span>);
			<span class="hljs-variable">$command</span> = <span class="hljs-string">"$cuty $proxy --max-wait=$timeout --user-agent=\"$ua\" --javascript=$jsOn --java=$javaOn --plugins=$pluginsOn --js-can-open-windows=off --url=\"$url\" --out-format=$format --out=$tempfile"</span>;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$command</span> = <span class="hljs-string">"$xv --server-args=\"-screen 0, {$screenX}x{$screenY}x{$colDepth}\" $cuty $proxy --max-wait=$timeout --user-agent=\"$ua\" --javascript=$jsOn --java=$javaOn --plugins=$pluginsOn --js-can-open-windows=off --url=\"$url\" --out-format=$format --out=$tempfile"</span>;
		}
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Executing command: $command"</span>);
		<span class="hljs-variable">$out</span> = `<span class="hljs-variable">$command</span>`;
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Received output: $out"</span>);
		<span class="hljs-keyword">if</span>(! is_file(<span class="hljs-variable">$tempfile</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;set404</span>();
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"The command to create a thumbnail failed."</span>);
		}
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cropTop</span> = <span class="hljs-keyword">true</span>;
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;processImageAndWriteToCache</span>(<span class="hljs-variable">$tempfile</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Image processed succesfully. Serving from cache"</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;serveCacheFile</span>();
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveExternalImage</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">if</span>(! preg_match(<span class="hljs-string">'/^https?:\/\/[a-zA-Z0-9\-\.]+/i'</span>, <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Invalid URL supplied."</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
		<span class="hljs-variable">$tempfile</span> = tempnam(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cacheDirectory</span>, <span class="hljs-string">'timthumb'</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Fetching external image into temporary file $tempfile"</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;toDelete</span>(<span class="hljs-variable">$tempfile</span>);
		<span class="hljs-comment">#fetch file here</span>
		<span class="hljs-keyword">if</span>(! <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;getURL</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;src</span>, <span class="hljs-variable">$tempfile</span>)){
			@unlink(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);
			touch(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Error fetching URL: "</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;lastURLError</span>);
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Error reading the URL you specified from remote host."</span> . <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;lastURLError</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}

		<span class="hljs-variable">$mimeType</span> = <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;getMimeType</span>(<span class="hljs-variable">$tempfile</span>);
		<span class="hljs-keyword">if</span>(! preg_match(<span class="hljs-string">"/^image\/(?:jpg|jpeg|gif|png)$/i"</span>, <span class="hljs-variable">$mimeType</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Remote file has invalid mime type: $mimeType"</span>);
			@unlink(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);
			touch(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"The remote file is not a valid image. Mimetype = '"</span> . <span class="hljs-variable">$mimeType</span> . <span class="hljs-string">"'"</span> . <span class="hljs-variable">$tempfile</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;processImageAndWriteToCache</span>(<span class="hljs-variable">$tempfile</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Image processed succesfully. Serving from cache"</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;serveCacheFile</span>();
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
	}
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curlWrite</span><span class="hljs-params">(<span class="hljs-variable">$h</span>, <span class="hljs-variable">$d</span>)</span></span>{
		fwrite(<span class="hljs-keyword">self</span>::<span class="hljs-variable">$curlFH</span>, <span class="hljs-variable">$d</span>);
		<span class="hljs-keyword">self</span>::<span class="hljs-variable">$curlDataWritten</span> += strlen(<span class="hljs-variable">$d</span>);
		<span class="hljs-keyword">if</span>(<span class="hljs-keyword">self</span>::<span class="hljs-variable">$curlDataWritten</span> &gt; MAX_FILE_SIZE){
			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">return</span> strlen(<span class="hljs-variable">$d</span>);
		}
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveCacheFile</span><span class="hljs-params">()</span></span>{
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Serving {$this-&gt;cachefile}"</span>);
		<span class="hljs-keyword">if</span>(! is_file(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"serveCacheFile called in timthumb but we couldn't find the cached file."</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
		<span class="hljs-variable">$fp</span> = fopen(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>, <span class="hljs-string">'rb'</span>);
		<span class="hljs-keyword">if</span>(! <span class="hljs-variable">$fp</span>){ <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not open cachefile."</span>); }
		fseek(<span class="hljs-variable">$fp</span>, strlen(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;filePrependSecurityBlock</span>), SEEK_SET);
		<span class="hljs-variable">$imgType</span> = fread(<span class="hljs-variable">$fp</span>, <span class="hljs-number">3</span>);
		fseek(<span class="hljs-variable">$fp</span>, <span class="hljs-number">3</span>, SEEK_CUR);
		<span class="hljs-keyword">if</span>(ftell(<span class="hljs-variable">$fp</span>) != strlen(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;filePrependSecurityBlock</span>) + <span class="hljs-number">6</span>){
			@unlink(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"The cached image file seems to be corrupt."</span>);
		}
		<span class="hljs-variable">$imageDataSize</span> = filesize(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>) - (strlen(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;filePrependSecurityBlock</span>) + <span class="hljs-number">6</span>);
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;sendImageHeaders</span>(<span class="hljs-variable">$imgType</span>, <span class="hljs-variable">$imageDataSize</span>);
		<span class="hljs-variable">$bytesSent</span> = @fpassthru(<span class="hljs-variable">$fp</span>);
		fclose(<span class="hljs-variable">$fp</span>);
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$bytesSent</span> &gt; <span class="hljs-number">0</span>){
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
		}
		<span class="hljs-variable">$content</span> = file_get_contents (<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;cachefile</span>);
		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$content</span> != <span class="hljs-keyword">FALSE</span>) {
			<span class="hljs-variable">$content</span> = substr(<span class="hljs-variable">$content</span>, strlen(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;filePrependSecurityBlock</span>) + <span class="hljs-number">6</span>);
			<span class="hljs-keyword">echo</span> <span class="hljs-variable">$content</span>;
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Served using file_get_contents and echo"</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Cache file could not be loaded."</span>);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendImageHeaders</span><span class="hljs-params">(<span class="hljs-variable">$mimeType</span>, <span class="hljs-variable">$dataSize</span>)</span></span>{
		<span class="hljs-keyword">if</span>(! preg_match(<span class="hljs-string">'/^image\//i'</span>, <span class="hljs-variable">$mimeType</span>)){
			<span class="hljs-variable">$mimeType</span> = <span class="hljs-string">'image/'</span> . <span class="hljs-variable">$mimeType</span>;
		}
		<span class="hljs-keyword">if</span>(strtolower(<span class="hljs-variable">$mimeType</span>) == <span class="hljs-string">'image/jpg'</span>){
			<span class="hljs-variable">$mimeType</span> = <span class="hljs-string">'image/jpeg'</span>;
		}
		<span class="hljs-variable">$gmdate_expires</span> = gmdate (<span class="hljs-string">'D, d M Y H:i:s'</span>, strtotime (<span class="hljs-string">'now +10 days'</span>)) . <span class="hljs-string">' GMT'</span>;
		<span class="hljs-variable">$gmdate_modified</span> = gmdate (<span class="hljs-string">'D, d M Y H:i:s'</span>) . <span class="hljs-string">' GMT'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>send content headers then display image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		header (<span class="hljs-string">'Content-Type: '</span> . <span class="hljs-variable">$mimeType</span>);
		header (<span class="hljs-string">'Accept-Ranges: none'</span>); <span class="hljs-comment">//Changed this because we don't accept range requests</span>
		header (<span class="hljs-string">'Last-Modified: '</span> . <span class="hljs-variable">$gmdate_modified</span>);
		header (<span class="hljs-string">'Content-Length: '</span> . <span class="hljs-variable">$dataSize</span>);
		<span class="hljs-keyword">if</span>(BROWSER_CACHE_DISABLE){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Browser cache is disabled so setting non-caching headers."</span>);
			header(<span class="hljs-string">'Cache-Control: no-store, no-cache, must-revalidate, max-age=0'</span>);
			header(<span class="hljs-string">"Pragma: no-cache"</span>);
			header(<span class="hljs-string">'Expires: '</span> . gmdate (<span class="hljs-string">'D, d M Y H:i:s'</span>, time()));
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Browser caching is enabled"</span>);
			header(<span class="hljs-string">'Cache-Control: max-age='</span> . BROWSER_CACHE_MAX_AGE . <span class="hljs-string">', must-revalidate'</span>);
			header(<span class="hljs-string">'Expires: '</span> . <span class="hljs-variable">$gmdate_expires</span>);
		}
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">securityChecks</span><span class="hljs-params">()</span></span>{
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">param</span><span class="hljs-params">(<span class="hljs-variable">$property</span>, <span class="hljs-variable">$default</span> = <span class="hljs-string">''</span>)</span></span>{
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-variable">$property</span>])) {
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$_GET</span>[<span class="hljs-variable">$property</span>];
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$default</span>;
		}
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">openImage</span><span class="hljs-params">(<span class="hljs-variable">$mimeType</span>, <span class="hljs-variable">$src</span>)</span></span>{
		<span class="hljs-keyword">switch</span> (<span class="hljs-variable">$mimeType</span>) {
			<span class="hljs-keyword">case</span> <span class="hljs-string">'image/jpeg'</span>:
				<span class="hljs-variable">$image</span> = imagecreatefromjpeg (<span class="hljs-variable">$src</span>);
				<span class="hljs-keyword">break</span>;

			<span class="hljs-keyword">case</span> <span class="hljs-string">'image/png'</span>:
				<span class="hljs-variable">$image</span> = imagecreatefrompng (<span class="hljs-variable">$src</span>);
				imagealphablending( <span class="hljs-variable">$image</span>, <span class="hljs-keyword">true</span> );
				imagesavealpha( <span class="hljs-variable">$image</span>, <span class="hljs-keyword">true</span> );
				<span class="hljs-keyword">break</span>;

			<span class="hljs-keyword">case</span> <span class="hljs-string">'image/gif'</span>:
				<span class="hljs-variable">$image</span> = imagecreatefromgif (<span class="hljs-variable">$src</span>);
				<span class="hljs-keyword">break</span>;
			
			<span class="hljs-keyword">default</span>:
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Unrecognised mimeType"</span>);
		}

		<span class="hljs-keyword">return</span> <span class="hljs-variable">$image</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getIP</span><span class="hljs-params">()</span></span>{
		<span class="hljs-variable">$rem</span> = @<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">"REMOTE_ADDR"</span>];
		<span class="hljs-variable">$ff</span> = @<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">"HTTP_X_FORWARDED_FOR"</span>];
		<span class="hljs-variable">$ci</span> = @<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">"HTTP_CLIENT_IP"</span>];
		<span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/^(?:192\.168|172\.16|10\.|127\.)/'</span>, <span class="hljs-variable">$rem</span>)){ 
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$ff</span>){ <span class="hljs-keyword">return</span> <span class="hljs-variable">$ff</span>; }
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$ci</span>){ <span class="hljs-keyword">return</span> <span class="hljs-variable">$ci</span>; }
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$rem</span>;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$rem</span>){ <span class="hljs-keyword">return</span> <span class="hljs-variable">$rem</span>; }
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$ff</span>){ <span class="hljs-keyword">return</span> <span class="hljs-variable">$ff</span>; }
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$ci</span>){ <span class="hljs-keyword">return</span> <span class="hljs-variable">$ci</span>; }
			<span class="hljs-keyword">return</span> <span class="hljs-string">"UNKNOWN"</span>;
		}
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-variable">$level</span>, <span class="hljs-variable">$msg</span>)</span></span>{
		<span class="hljs-keyword">if</span>(DEBUG_ON &amp;&amp; <span class="hljs-variable">$level</span> &lt;= DEBUG_LEVEL){
			<span class="hljs-variable">$execTime</span> = sprintf(<span class="hljs-string">'%.6f'</span>, microtime(<span class="hljs-keyword">true</span>) - <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;startTime</span>);
			<span class="hljs-variable">$tick</span> = sprintf(<span class="hljs-string">'%.6f'</span>, <span class="hljs-number">0</span>);
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;lastBenchTime</span> &gt; <span class="hljs-number">0</span>){
				<span class="hljs-variable">$tick</span> = sprintf(<span class="hljs-string">'%.6f'</span>, microtime(<span class="hljs-keyword">true</span>) - <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;lastBenchTime</span>);
			}
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;lastBenchTime</span> = microtime(<span class="hljs-keyword">true</span>);
			error_log(<span class="hljs-string">"TimThumb Debug line "</span> . <span class="hljs-keyword">__LINE__</span> . <span class="hljs-string">" [$execTime : $tick]: $msg"</span>);
		}
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sanityFail</span><span class="hljs-params">(<span class="hljs-variable">$msg</span>)</span></span>{
		<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"There is a problem in the timthumb code. Message: Please report this error at &lt;a href='http://code.google.com/p/timthumb/issues/list'&gt;timthumb's bug tracking page&lt;/a&gt;: $msg"</span>);
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMimeType</span><span class="hljs-params">(<span class="hljs-variable">$file</span>)</span></span>{
		<span class="hljs-variable">$info</span> = getimagesize(<span class="hljs-variable">$file</span>);
		<span class="hljs-keyword">if</span>(is_array(<span class="hljs-variable">$info</span>) &amp;&amp; <span class="hljs-variable">$info</span>[<span class="hljs-string">'mime'</span>]){
			<span class="hljs-keyword">return</span> <span class="hljs-variable">$info</span>[<span class="hljs-string">'mime'</span>];
		}
		<span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setMemoryLimit</span><span class="hljs-params">()</span></span>{
		<span class="hljs-variable">$inimem</span> = ini_get(<span class="hljs-string">'memory_limit'</span>);
		<span class="hljs-variable">$inibytes</span> = timthumb::returnBytes(<span class="hljs-variable">$inimem</span>);
		<span class="hljs-variable">$ourbytes</span> = timthumb::returnBytes(MEMORY_LIMIT);
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$inibytes</span> &lt; <span class="hljs-variable">$ourbytes</span>){
			ini_set (<span class="hljs-string">'memory_limit'</span>, MEMORY_LIMIT);
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Increased memory from $inimem to "</span> . MEMORY_LIMIT);
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Not adjusting memory size because the current setting is "</span> . <span class="hljs-variable">$inimem</span> . <span class="hljs-string">" and our size of "</span> . MEMORY_LIMIT . <span class="hljs-string">" is smaller."</span>);
		}
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">returnBytes</span><span class="hljs-params">(<span class="hljs-variable">$size_str</span>)</span></span>{
		<span class="hljs-keyword">switch</span> (substr (<span class="hljs-variable">$size_str</span>, -<span class="hljs-number">1</span>))
		{
			<span class="hljs-keyword">case</span> <span class="hljs-string">'M'</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">'m'</span>: <span class="hljs-keyword">return</span> (int)<span class="hljs-variable">$size_str</span> * <span class="hljs-number">1048576</span>;
			<span class="hljs-keyword">case</span> <span class="hljs-string">'K'</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">'k'</span>: <span class="hljs-keyword">return</span> (int)<span class="hljs-variable">$size_str</span> * <span class="hljs-number">1024</span>;
			<span class="hljs-keyword">case</span> <span class="hljs-string">'G'</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">'g'</span>: <span class="hljs-keyword">return</span> (int)<span class="hljs-variable">$size_str</span> * <span class="hljs-number">1073741824</span>;
			<span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-variable">$size_str</span>;
		}
	}
	
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getURL</span><span class="hljs-params">(<span class="hljs-variable">$url</span>, <span class="hljs-variable">$tempfile</span>)</span></span>{
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;lastURLError</span> = <span class="hljs-keyword">false</span>;
		<span class="hljs-variable">$url</span> = preg_replace(<span class="hljs-string">'/ /'</span>, <span class="hljs-string">'%20'</span>, <span class="hljs-variable">$url</span>);
		<span class="hljs-keyword">if</span>(function_exists(<span class="hljs-string">'curl_init'</span>)){
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Curl is installed so using it to fetch URL."</span>);
			<span class="hljs-keyword">self</span>::<span class="hljs-variable">$curlFH</span> = fopen(<span class="hljs-variable">$tempfile</span>, <span class="hljs-string">'w'</span>);
			<span class="hljs-keyword">if</span>(! <span class="hljs-keyword">self</span>::<span class="hljs-variable">$curlFH</span>){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not open $tempfile for writing."</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			}
			<span class="hljs-keyword">self</span>::<span class="hljs-variable">$curlDataWritten</span> = <span class="hljs-number">0</span>;
			<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;debug</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"Fetching url with curl: $url"</span>);
			<span class="hljs-variable">$curl</span> = curl_init(<span class="hljs-variable">$url</span>);
			curl_setopt (<span class="hljs-variable">$curl</span>, CURLOPT_TIMEOUT, CURL_TIMEOUT);
			curl_setopt (<span class="hljs-variable">$curl</span>, CURLOPT_USERAGENT, <span class="hljs-string">"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/534.30 (KHTML, like Gecko) Chrome/12.0.742.122 Safari/534.30"</span>);
			curl_setopt (<span class="hljs-variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-keyword">TRUE</span>);
			curl_setopt (<span class="hljs-variable">$curl</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);
			curl_setopt (<span class="hljs-variable">$curl</span>, CURLOPT_SSL_VERIFYPEER, <span class="hljs-keyword">FALSE</span>);
			curl_setopt (<span class="hljs-variable">$curl</span>, CURLOPT_WRITEFUNCTION, <span class="hljs-string">'timthumb::curlWrite'</span>);
			@curl_setopt (<span class="hljs-variable">$curl</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-keyword">true</span>);
			@curl_setopt (<span class="hljs-variable">$curl</span>, CURLOPT_MAXREDIRS, <span class="hljs-number">10</span>);
			
			<span class="hljs-variable">$curlResult</span> = curl_exec(<span class="hljs-variable">$curl</span>);
			fclose(<span class="hljs-keyword">self</span>::<span class="hljs-variable">$curlFH</span>);
			<span class="hljs-variable">$httpStatus</span> = curl_getinfo(<span class="hljs-variable">$curl</span>, CURLINFO_HTTP_CODE);
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$httpStatus</span> == <span class="hljs-number">404</span>){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;set404</span>();
			}
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$httpStatus</span> == <span class="hljs-number">302</span>){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"External Image is Redirecting. Try alternate image url"</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			}
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$curlResult</span>){
				curl_close(<span class="hljs-variable">$curl</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;lastURLError</span> = curl_error(<span class="hljs-variable">$curl</span>);
				curl_close(<span class="hljs-variable">$curl</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			}
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-variable">$img</span> = @file_get_contents (<span class="hljs-variable">$url</span>);
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$img</span> === <span class="hljs-keyword">false</span>){
				<span class="hljs-variable">$err</span> = error_get_last();
				<span class="hljs-keyword">if</span>(is_array(<span class="hljs-variable">$err</span>) &amp;&amp; <span class="hljs-variable">$err</span>[<span class="hljs-string">'message'</span>]){
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;lastURLError</span> = <span class="hljs-variable">$err</span>[<span class="hljs-string">'message'</span>];
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;lastURLError</span> = <span class="hljs-variable">$err</span>;
				}
				<span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/404/'</span>, <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;lastURLError</span>)){
					<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;set404</span>();
				}

				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			}
			<span class="hljs-keyword">if</span>(! file_put_contents(<span class="hljs-variable">$tempfile</span>, <span class="hljs-variable">$img</span>)){
				<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;error</span>(<span class="hljs-string">"Could not write to $tempfile."</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
			}
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
		}

	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveImg</span><span class="hljs-params">(<span class="hljs-variable">$file</span>)</span></span>{
		<span class="hljs-variable">$s</span> = getimagesize(<span class="hljs-variable">$file</span>);
		<span class="hljs-keyword">if</span>(! (<span class="hljs-variable">$s</span> &amp;&amp; <span class="hljs-variable">$s</span>[<span class="hljs-string">'mime'</span>])){
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
		}
		header (<span class="hljs-string">'Content-Type: '</span> . <span class="hljs-variable">$s</span>[<span class="hljs-string">'mime'</span>]);
		header (<span class="hljs-string">'Content-Length: '</span> . filesize(<span class="hljs-variable">$file</span>) );
		header (<span class="hljs-string">'Cache-Control: no-store, no-cache, must-revalidate, max-age=0'</span>);
		header (<span class="hljs-string">"Pragma: no-cache"</span>);
		<span class="hljs-variable">$bytes</span> = @readfile(<span class="hljs-variable">$file</span>);
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$bytes</span> &gt; <span class="hljs-number">0</span>){
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
		}
		<span class="hljs-variable">$content</span> = @file_get_contents (<span class="hljs-variable">$file</span>);
		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$content</span> != <span class="hljs-keyword">FALSE</span>){
			<span class="hljs-keyword">echo</span> <span class="hljs-variable">$content</span>;
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
		}
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;

	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set404</span><span class="hljs-params">()</span></span>{
		<span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;is404</span> = <span class="hljs-keyword">true</span>;
	}
	<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is404</span><span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span><span class="hljs-variable">-&gt;is404</span>;
	}
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
